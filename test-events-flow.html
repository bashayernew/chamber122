<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Events Flow - Chamber122</title>
  <script>
    window.SUPABASE_URL = "https://gidbvemmqffogakcepka.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZGJ2ZW1tcWZmb2dha2NlcGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NjI0MTUsImV4cCI6MjA3MjMzODQxNX0.rFFi4gq5ZUApmJM_FM5nfGpcPCHy9FLedVwmJOEzV1w";
  </script>
  <script src="/js/supabase-client.js?v=20"></script>
  <script src="/js/events.js?v=8"></script>
  <script src="/js/activities-list.js?v=8"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
    .test-section { margin: 20px 0; padding: 20px; border: 1px solid #333; border-radius: 8px; }
    .test-button { background: #6f75ff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
    .test-button:hover { background: #5a5fcf; }
    .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
    .success { background: #2d5a2d; border: 1px solid #4a7c4a; }
    .error { background: #5a2d2d; border: 1px solid #7c4a4a; }
    .info { background: #2d4a5a; border: 1px solid #4a6a7c; }
    #events-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
    .event-card { background: #2a2a2a; padding: 20px; border-radius: 8px; border: 1px solid #333; }
  </style>
</head>
<body>
  <h1>üß™ Events Flow Test Page</h1>
  
  <div class="test-section">
    <h2>1. Script Loading Tests</h2>
    <button class="test-button" onclick="testScriptLoading()">Test Script Loading</button>
    <div id="script-test-result"></div>
  </div>

  <div class="test-section">
    <h2>2. Supabase Connection Test</h2>
    <button class="test-button" onclick="testSupabaseConnection()">Test Supabase Connection</button>
    <div id="supabase-test-result"></div>
  </div>

  <div class="test-section">
    <h2>3. Events Loading Test</h2>
    <button class="test-button" onclick="testEventsLoading()">Load Events</button>
    <div id="events-test-result"></div>
    <div id="events-grid"></div>
  </div>

  <div class="test-section">
    <h2>4. Event Creation Test</h2>
    <button class="test-button" onclick="testEventCreation()">Test Event Creation</button>
    <div id="creation-test-result"></div>
  </div>

  <div class="test-section">
    <h2>5. Global Functions Test</h2>
    <button class="test-button" onclick="testGlobalFunctions()">Test Global Functions</button>
    <div id="global-test-result"></div>
  </div>

  <script>
    // Test script loading
    function testScriptLoading() {
      const result = document.getElementById('script-test-result');
      
      const tests = [
        { name: 'Supabase client', test: () => !!window.supabase },
        { name: 'Events script', test: () => !!window.openEventForm },
        { name: 'Activities script', test: () => !!window.reloadActivities },
        { name: 'Test import function', test: () => typeof window.testImport === 'function' }
      ];
      
      let html = '<h3>Script Loading Results:</h3>';
      let allPassed = true;
      
      tests.forEach(test => {
        const passed = test.test();
        allPassed = allPassed && passed;
        html += `<div class="test-result ${passed ? 'success' : 'error'}">
          ${passed ? '‚úÖ' : '‚ùå'} ${test.name}: ${passed ? 'Loaded' : 'Failed'}
        </div>`;
      });
      
      if (allPassed) {
        html += '<div class="test-result success">üéâ All scripts loaded successfully!</div>';
      } else {
        html += '<div class="test-result error">‚ùå Some scripts failed to load</div>';
      }
      
      result.innerHTML = html;
    }

    // Test Supabase connection
    async function testSupabaseConnection() {
      const result = document.getElementById('supabase-test-result');
      result.innerHTML = '<div class="test-result info">Testing Supabase connection...</div>';
      
      try {
        const { data, error } = await window.supabase
          .from('businesses')
          .select('count')
          .limit(1);
        
        if (error) throw error;
        
        result.innerHTML = '<div class="test-result success">‚úÖ Supabase connection successful!</div>';
      } catch (error) {
        result.innerHTML = `<div class="test-result error">‚ùå Supabase connection failed: ${error.message}</div>`;
      }
    }

    // Test events loading
    async function testEventsLoading() {
      const result = document.getElementById('events-test-result');
      const grid = document.getElementById('events-grid');
      
      result.innerHTML = '<div class="test-result info">Loading events...</div>';
      grid.innerHTML = '';
      
      try {
        const { data, error } = await window.supabase
          .from('activities')
          .select('*')
          .eq('kind', 'event')
          .or('status.eq.published,is_published.is.true')
          .order('sort_at', { ascending: false })
          .limit(5);
        
        if (error) throw error;
        
        if (data && data.length > 0) {
          result.innerHTML = `<div class="test-result success">‚úÖ Loaded ${data.length} events successfully!</div>`;
          
          data.forEach(event => {
            const card = document.createElement('div');
            card.className = 'event-card';
            card.innerHTML = `
              <h3>${event.title || 'Untitled Event'}</h3>
              <p>${event.description || 'No description'}</p>
              <p><strong>Location:</strong> ${event.location || 'TBA'}</p>
              <p><strong>Date:</strong> ${event.start_at ? new Date(event.start_at).toLocaleDateString() : 'TBA'}</p>
            `;
            grid.appendChild(card);
          });
        } else {
          result.innerHTML = '<div class="test-result info">‚ÑπÔ∏è No events found in database</div>';
        }
      } catch (error) {
        result.innerHTML = `<div class="test-result error">‚ùå Failed to load events: ${error.message}</div>`;
      }
    }

    // Test event creation
    async function testEventCreation() {
      const result = document.getElementById('creation-test-result');
      result.innerHTML = '<div class="test-result info">Testing event creation...</div>';
      
      try {
        // First, get a business ID
        const { data: businesses, error: bizError } = await window.supabase
          .from('businesses')
          .select('id')
          .limit(1);
        
        if (bizError) throw bizError;
        
        if (!businesses || businesses.length === 0) {
          result.innerHTML = '<div class="test-result error">‚ùå No businesses found. Please create a business first.</div>';
          return;
        }
        
        const businessId = businesses[0].id;
        
        // Create a test event
        const testEvent = {
          business_id: businessId,
          title: 'Test Event - ' + new Date().toISOString(),
          description: 'This is a test event created by the test page',
          location: 'Test Location',
          start_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // Tomorrow
          status: 'published',
          is_published: true
        };
        
        const { data, error } = await window.supabase
          .from('events')
          .insert([testEvent])
          .select()
          .single();
        
        if (error) throw error;
        
        result.innerHTML = `<div class="test-result success">‚úÖ Event created successfully! ID: ${data.id}</div>`;
        
        // Refresh events list
        setTimeout(() => {
          testEventsLoading();
        }, 1000);
        
      } catch (error) {
        result.innerHTML = `<div class="test-result error">‚ùå Event creation failed: ${error.message}</div>`;
      }
    }

    // Test global functions
    function testGlobalFunctions() {
      const result = document.getElementById('global-test-result');
      
      const tests = [
        { name: 'window.openEventForm', test: () => typeof window.openEventForm === 'function' },
        { name: 'window.closeEventForm', test: () => typeof window.closeEventForm === 'function' },
        { name: 'window.loadEvents', test: () => typeof window.loadEvents === 'function' },
        { name: 'window.reloadActivities', test: () => typeof window.reloadActivities === 'function' },
        { name: 'window.testImport', test: () => typeof window.testImport === 'function' }
      ];
      
      let html = '<h3>Global Functions Test:</h3>';
      let allPassed = true;
      
      tests.forEach(test => {
        const passed = test.test();
        allPassed = allPassed && passed;
        html += `<div class="test-result ${passed ? 'success' : 'error'}">
          ${passed ? '‚úÖ' : '‚ùå'} ${test.name}: ${passed ? 'Available' : 'Missing'}
        </div>`;
      });
      
      if (allPassed) {
        html += '<div class="test-result success">üéâ All global functions available!</div>';
        
        // Test the testImport function
        try {
          const testResult = window.testImport();
          html += `<div class="test-result success">‚úÖ window.testImport() returned: "${testResult}"</div>`;
        } catch (error) {
          html += `<div class="test-result error">‚ùå window.testImport() failed: ${error.message}</div>`;
        }
      } else {
        html += '<div class="test-result error">‚ùå Some global functions are missing</div>';
      }
      
      result.innerHTML = html;
    }

    // Auto-run tests on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üß™ Events Flow Test Page loaded');
      console.log('Available functions:', {
        openEventForm: typeof window.openEventForm,
        reloadActivities: typeof window.reloadActivities,
        testImport: typeof window.testImport
      });
    });
  </script>
</body>
</html>
