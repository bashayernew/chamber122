<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    window.SUPABASE_URL = "https://gidbvemmqffogakcepka.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZGJ2ZW1tcWZmb2dha2NlcGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NjI0MTUsImV4cCI6MjA3MjMzODQxNX0.rFFi4gq5ZUApmJM_FM5nfGpcPCHy9FLedVwmJOEzV1w";
  </script>
  <script type="module" src="js/supabase-client.js?v=20"></script>
<script type="module" src="js/auth-session.js?v=1"></script>
  <script type="module" src="js/site-header.js?v=1"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply Activities Ownership Migration</title>
    <meta name="supabase-url" content="https://gidbvemmqffogakcepka.supabase.co">
    <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZGJ2ZW1tcWZmb2dha2NlcGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NjI0MTUsImV4cCI6MjA3MjMzODQxNX0.rFFi4gq5ZUApmJM_FM5nfGpcPCHy9FLedVwmJOEzV1w">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #333; border-radius: 8px; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        button { padding: 12px 24px; margin: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        button:hover { background: #2563eb; }
        button:disabled { background: #6b7280; cursor: not-allowed; }
        pre { background: #2d2d2d; padding: 15px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; }
        .step { margin: 15px 0; padding: 15px; background: #2a2a2a; border-radius: 6px; }
        .step h3 { margin-top: 0; color: #60a5fa; }
        .sql-code { background: #1e1e1e; border: 1px solid #444; border-radius: 4px; padding: 10px; font-family: 'Courier New', monospace; }
    </style>
    <link rel="stylesheet" href="css/header.css?v=1">
</head>
<body>
    <!-- Global Header -->
    <div id="site-header"></div>
    
    <div class="container">
        <h1>üîê Apply Activities Ownership Migration</h1>
        
        <div class="section">
            <h2>Migration Overview</h2>
            <p>This migration will:</p>
            <ul>
                <li>‚úÖ Update activities table to reference businesses instead of accounts</li>
                <li>‚úÖ Backfill created_by column from business owners</li>
                <li>‚úÖ Add triggers to auto-populate created_by on new activities</li>
                <li>‚úÖ Add RLS policies for secure access control</li>
                <li>‚úÖ Add performance indexes</li>
            </ul>
        </div>

        <div class="section">
            <h2>Step 1: Check Current State</h2>
            <p>First, let's verify the current activities table structure and data.</p>
            <button onclick="checkCurrentState()">Check Current State</button>
            <div id="current-state-result"></div>
        </div>

        <div class="section">
            <h2>Step 2: Apply Migration</h2>
            <p>Copy and paste the SQL migration into your Supabase SQL Editor.</p>
            <button onclick="showMigrationSQL()">Show Migration SQL</button>
            <div id="migration-sql-result"></div>
        </div>

        <div class="section">
            <h2>Step 3: Verify Migration</h2>
            <p>After applying the migration, verify it worked correctly.</p>
            <button onclick="verifyMigration()">Verify Migration</button>
            <div id="verification-result"></div>
        </div>

        <div class="section">
            <h2>Step 4: Test Activities</h2>
            <p>Test that activities can be queried and created correctly.</p>
            <button onclick="testActivities()">Test Activities</button>
            <div id="test-result"></div>
        </div>
    </div>

    <script type="module">
        import { supabase } from './js/supabase-client.js';

        // Step 1: Check Current State
        window.checkCurrentState = async () => {
            const resultDiv = document.getElementById('current-state-result');
            resultDiv.innerHTML = '<p class="info">Checking current state...</p>';
            
            try {
                // Check if user is logged in
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    resultDiv.innerHTML = '<p class="warning">‚ö†Ô∏è Please log in first to check the database state.</p>';
                    return;
                }

                // Check activities table structure
                const { data: activities, error: activitiesError } = await supabase
                    .from('activities')
                    .select('*')
                    .limit(1);

                if (activitiesError) {
                    resultDiv.innerHTML = `
                        <p class="error">‚ùå Error accessing activities table:</p>
                        <pre>${activitiesError.message}</pre>
                    `;
                    return;
                }

                // Check businesses table
                const { data: businesses, error: businessesError } = await supabase
                    .from('businesses')
                    .select('id, owner_id')
                    .limit(1);

                if (businessesError) {
                    resultDiv.innerHTML = `
                        <p class="error">‚ùå Error accessing businesses table:</p>
                        <pre>${businessesError.message}</pre>
                    `;
                    return;
                }

                // Check accounts view
                const { data: accounts, error: accountsError } = await supabase
                    .from('accounts')
                    .select('id, owner_user_id')
                    .limit(1);

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Database accessible</p>
                    <p class="info">Activities table: ${activities.length > 0 ? 'Has data' : 'Empty'}</p>
                    <p class="info">Businesses table: ${businesses.length > 0 ? 'Has data' : 'Empty'}</p>
                    <p class="info">Accounts view: ${accounts.length > 0 ? 'Has data' : 'Empty'}</p>
                    <p class="info">Current user: ${user.email}</p>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Error checking current state:</p>
                    <pre>${error.message}</pre>
                `;
            }
        };

        // Step 2: Show Migration SQL
        window.showMigrationSQL = () => {
            const resultDiv = document.getElementById('migration-sql-result');
            
            const migrationSQL = `-- Activities Ownership Migration
-- Updates activities table to work with businesses table and improves RLS

-- 1.1 Update foreign key reference from accounts to businesses
-- First, we need to check if we can safely update the reference
-- This assumes activities.business_id should reference businesses.id instead of accounts.id
alter table public.activities
  drop constraint if exists activities_business_id_fkey;

alter table public.activities
  add constraint activities_business_id_fkey
  foreign key (business_id) references public.businesses(id) on delete cascade;

-- 1.2 Backfill created_by from businesses.owner_id (using the accounts view for compatibility)
update public.activities a
set created_by = b.owner_user_id
from public.accounts b
where a.business_id = b.id
  and a.created_by is null;

-- 1.3 Indexes for performance
create index if not exists idx_activities_created_by on public.activities(created_by);
create index if not exists idx_activities_created_at on public.activities(created_at);

-- 1.4 Helper function: admin checker
create or replace function public.is_admin(uid uuid)
returns boolean language sql stable as
$$
  select exists (select 1 from public.admins where user_id = uid);
$$;
grant execute on function public.is_admin(uuid) to anon, authenticated;

-- 1.5 Trigger function to auto-populate created_by from business owner
create or replace function public.set_activity_owner()
returns trigger language plpgsql as
$$
declare v_owner uuid;
begin
  -- If created_by already provided, keep it; else derive from business_id
  if new.created_by is null then
    -- Try to get owner from businesses table first, fallback to accounts view
    select owner_id into v_owner from public.businesses where id = new.business_id;
    if v_owner is null then
      select owner_user_id into v_owner from public.accounts where id = new.business_id;
    end if;
    new.created_by := v_owner;
  end if;

  -- Ensure created_at has a value
  if new.created_at is null then
    new.created_at := now();
  end if;

  return new;
end;
$$;

-- 1.6 Triggers
drop trigger if exists trg_activities_set_owner_ins on public.activities;
create trigger trg_activities_set_owner_ins
before insert on public.activities
for each row execute function public.set_activity_owner();

drop trigger if exists trg_activities_set_owner_upd on public.activities;
create trigger trg_activities_set_owner_upd
before update on public.activities
for each row execute function public.set_activity_owner();

-- 1.7 RLS Policies
alter table public.activities enable row level security;

-- Clear old policies for a clean slate
drop policy if exists "owner read activities" on public.activities;
drop policy if exists "owner write activities" on public.activities;
drop policy if exists "admin read activities" on public.activities;
drop policy if exists "owner or admin read activities" on public.activities;
drop policy if exists "owner insert activities" on public.activities;
drop policy if exists "owner update activities" on public.activities;

-- Owners can read their activities; admins can read all
create policy "owner or admin read activities"
on public.activities
for select
to authenticated
using (
  created_by = auth.uid() OR public.is_admin(auth.uid())
);

-- Owners can insert rows only if created_by resolves to them
create policy "owner insert activities"
on public.activities
for insert
to authenticated
with check (
  -- allow if explicitly set to self OR derives from a business they own
  created_by = auth.uid()
  OR exists (
    select 1 from public.businesses b
    where b.id = coalesce(new.business_id, public.activities.business_id)
      and b.owner_id = auth.uid()
  )
  OR exists (
    select 1 from public.accounts a
    where a.id = coalesce(new.business_id, public.activities.business_id)
      and a.owner_user_id = auth.uid()
  )
);

-- Owners can update rows they own; admins can update via service if needed
create policy "owner update activities"
on public.activities
for update
to authenticated
using (created_by = auth.uid())
with check (created_by = auth.uid());

-- 1.8 Grant necessary permissions
grant select, insert, update on public.activities to authenticated;
grant usage on sequence public.activities_id_seq to authenticated;`;

            resultDiv.innerHTML = `
                <p class="info">üìã Copy the SQL below and paste it into your Supabase SQL Editor:</p>
                <div class="sql-code">
                    <pre>${migrationSQL}</pre>
                </div>
                <p class="warning">‚ö†Ô∏è Make sure to run this in your Supabase SQL Editor, not here!</p>
            `;
        };

        // Step 3: Verify Migration
        window.verifyMigration = async () => {
            const resultDiv = document.getElementById('verification-result');
            resultDiv.innerHTML = '<p class="info">Verifying migration...</p>';
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    resultDiv.innerHTML = '<p class="warning">‚ö†Ô∏è Please log in first.</p>';
                    return;
                }

                // Test 1: Check if activities can be queried by created_by
                const { data: activities, error: activitiesError } = await supabase
                    .from('activities')
                    .select('id, title, created_by, created_at')
                    .eq('created_by', user.id)
                    .limit(5);

                if (activitiesError) {
                    resultDiv.innerHTML = `
                        <p class="error">‚ùå Migration verification failed:</p>
                        <pre>${activitiesError.message}</pre>
                    `;
                    return;
                }

                // Test 2: Check if triggers are working by trying to insert
                const { data: business } = await supabase
                    .from('businesses')
                    .select('id')
                    .eq('owner_id', user.id)
                    .limit(1)
                    .single();

                let triggerTest = 'Skipped (no business found)';
                if (business) {
                    const testActivity = {
                        business_id: business.id,
                        title: `Migration Test ${Date.now()}`,
                        content: 'Testing trigger functionality',
                        status: 'draft'
                    };

                    const { data: inserted, error: insertError } = await supabase
                        .from('activities')
                        .insert([testActivity])
                        .select('id, created_by')
                        .single();

                    if (insertError) {
                        triggerTest = `Failed: ${insertError.message}`;
                    } else {
                        triggerTest = inserted.created_by === user.id ? '‚úÖ Working' : '‚ùå Failed (wrong owner)';
                    }
                }

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Migration verification complete</p>
                    <p class="info">Activities query: ‚úÖ Working</p>
                    <p class="info">Found ${activities.length} activities for user</p>
                    <p class="info">Trigger test: ${triggerTest}</p>
                    <pre>${JSON.stringify(activities, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Error verifying migration:</p>
                    <pre>${error.message}</pre>
                `;
            }
        };

        // Step 4: Test Activities
        window.testActivities = async () => {
            const resultDiv = document.getElementById('test-result');
            resultDiv.innerHTML = '<p class="info">Testing activities functionality...</p>';
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    resultDiv.innerHTML = '<p class="warning">‚ö†Ô∏è Please log in first.</p>';
                    return;
                }

                // Test querying activities
                const { data: activities, error: queryError } = await supabase
                    .from('activities')
                    .select('id, title, created_by, created_at')
                    .eq('created_by', user.id)
                    .order('created_at', { ascending: false })
                    .limit(3);

                if (queryError) {
                    resultDiv.innerHTML = `
                        <p class="error">‚ùå Query test failed:</p>
                        <pre>${queryError.message}</pre>
                    `;
                    return;
                }

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Activities functionality working</p>
                    <p class="info">Found ${activities.length} activities</p>
                    <p class="info">All activities belong to user: ${user.id}</p>
                    <pre>${JSON.stringify(activities, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Error testing activities:</p>
                    <pre>${error.message}</pre>
                `;
            }
        };

        // Auto-run on load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîê Activities Ownership Migration Helper loaded');
        });
    </script>
</body>
</html>
