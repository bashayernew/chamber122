<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    window.SUPABASE_URL = "https://gidbvemmqffogakcepka.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZGJ2ZW1tcWZmb2dha2NlcGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NjI0MTUsImV4cCI6MjA3MjMzODQxNX0.rFFi4gq5ZUApmJM_FM5nfGpcPCHy9FLedVwmJOEzV1w";
  </script>
  <script type="module" src="js/supabase-client.js?v=20"></script>
<script type="module" src="js/auth-session.js?v=1"></script>
  <script type="module" src="js/site-header.js?v=1"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events & Promotions | Chamber122</title>
  <meta name="description" content="Discover MSME events, promotions, training sessions, and networking opportunities in Kuwait.">
  <meta name="supabase-url" content="https://gidbvemmqffogakcepka.supabase.co">
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZGJ2ZW1tcWZmb2dha2NlcGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NjI0MTUsImV4cCI6MjA3MjMzODQxNX0.rFFi4gq5ZUApmJM_FM5nfGpcPCHy9FLedVwmJOEzV1w">
  <link rel="stylesheet" href="css/style.css?v=18">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body data-type="event">
  <!-- Global Header -->
  <div id="site-header"></div>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo site-logo">
        <img src="images/logo.png" alt="Chamber122 Logo">

      </a>
      <div class="nav-menu">
        <a href="index.html" class="nav-link" data-i18n="nav.home">Home</a>
        <a href="directory.html" class="nav-link" data-i18n="nav.directory">Directory</a>
        <a href="events.html" class="nav-link active" data-i18n="nav.events">Events</a>
        <a href="bulletin.html" class="nav-link" data-i18n="nav.bulletin">Bulletin</a>
        <a href="about.html" class="nav-link" data-i18n="nav.about">About</a>
        <a href="contact.html" class="nav-link" data-i18n="nav.contact">Contact</a>
      </div>
      <div class="nav-actions">
        <!-- Language toggle -->
        <span id="lang-toggle" class="lang-toggle" aria-label="Language">
          <button data-lang="en" class="lang-btn" data-testid="lang-switch-en">EN</button> |
          <button data-lang="ar" class="lang-btn" data-testid="lang-switch-ar">AR</button>
        </span>
        <!-- Auth CTAs (shown when NOT logged in) -->
        <div id="auth-cta" class="flex items-center gap-3" data-testid="auth-cta">
          <a href="auth.html#login" class="btn btn-ghost text-sm" data-testid="login-cta" data-i18n="nav.login">Login</a>
          <a href="auth.html#signup" class="btn btn-primary text-sm px-4 py-2 rounded-2xl shadow-sm" data-testid="signup-cta" data-i18n="nav.signup">
            Sign Up & Get Listed
          </a>
        </div>

        <!-- Account menu (shown ONLY when logged in) -->
        <div id="account-menu" class="relative hidden" data-testid="account-menu">
          <button id="account-btn" class="btn btn-outline flex items-center gap-2">
            <img id="account-avatar" src="" alt="" class="h-7 w-7 rounded-full object-cover hidden">
            <span id="account-name" data-i18n="nav.account">Account</span>
            <svg class="h-4 w-4 opacity-70" viewBox="0 0 20 20"><path d="M5 7l5 6 5-6"/></svg>
          </button>
          <div id="account-dropdown" class="menu hidden">
            <a href="owner-activities.html" data-testid="menu-my-activities" data-i18n="nav.myActivities">My Activities</a>
            <a href="admin-dashboard.html" id="menu-admin" class="hidden" data-testid="menu-admin" data-i18n="nav.admin">Admin Panel</a>
            <a href="#" id="btn-logout" data-testid="logout" data-i18n="nav.logout">Logout</a>
          </div>
        </div>
      </div>
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="mobile-link">Home</a>
      <a href="directory.html" class="mobile-link">Directory</a>
      <a href="events.html" class="mobile-link">Events</a>
      <a href="bulletin.html" class="mobile-link">Bulletin</a>
      <a href="about.html" class="mobile-link">About</a>
      <a href="contact.html" class="mobile-link">Contact</a>
      <div class="mobile-divider"></div>
      <a href="owner.html" class="mobile-link">
        <i class="fas fa-building"></i>
        My Business
      </a>
      <a href="owner-activities.html" class="mobile-link">
        <i class="fas fa-calendar-alt"></i>
        My Activities
      </a>
      <a href="admin.html" class="mobile-link">
        <i class="fas fa-cog"></i>
        Admin Panel
      </a>
      <div class="mobile-divider"></div>
      <a href="auth.html" class="mobile-link">
        <i class="fas fa-sign-in-alt"></i>
        Login
      </a>
      <a href="get-listed.html" class="mobile-link">
        <i class="fas fa-user-plus"></i>
        Sign Up & Get Listed
      </a>
    </div>
  </nav>

  <!-- Events Header -->
  <section class="events-header">
    <div class="events-hero">
      <h1 data-i18n="page.title">Events & Promotions</h1>
      <p data-i18n="page.subtitle">Discover upcoming events, training sessions, and promotional activities from Kuwait's MSME community</p>
    </div>
    
    <!-- Search and Filter Bar -->
    <div class="filter-container">
      <div class="filter-bar">
        <div class="filter-group">
          <label for="q" data-i18n="search.label">Search Events</label>
          <input type="text" id="q" class="filter-input" placeholder-i18n data-i18n="search.placeholder" placeholder="Search by title, description, or business...">
        </div>
        <div class="filter-group">
          <label for="range" data-i18n="filters.dateRange">Date Range</label>
          <select id="range" class="filter-input">
            <option value="all" data-i18n="filters.allEvents">All Events</option>
            <option value="today">Today</option>
            <option value="upcoming" data-i18n="filters.upcoming">Upcoming</option>
            <option value="past" data-i18n="filters.past">Past Events</option>
          </select>
        </div>
        <div class="filter-group">
          <button id="add-event-btn" class="add-event-btn" data-testid="add-event-btn">
            <i class="fas fa-plus"></i> <span data-i18n="buttons.addEvent">Add Event</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Events Actions -->
  <section class="events-actions">
    <!-- Add Event button is now in the filter bar above -->
  </section>

  <!-- Events Grid -->
  <section class="events-grid-section">
    <div class="events-grid" id="events-grid">
      <!-- Events will be populated by JavaScript -->
    </div>
    <!-- Also create the list container that activities.js expects -->
    <div id="activitiesList" class="list" style="display: none;"></div>
    
    <div class="load-more-container">
      <button class="load-more-btn" onclick="loadMoreActivities()">
        <i class="fas fa-plus"></i> Load More Events
      </button>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-brand">
        <img src="images/logo.png" alt="Chamber122" />
      </div>
      <div class="footer-section">
        <h3 data-i18n="footer.aboutTitle">Chamber122</h3>
        <p data-i18n="footer.about">Connecting Kuwait's MSMEs with opportunities for growth and success. Join our community today.</p>
      </div>
      
      <div class="footer-section">
        <h3 data-i18n="footer.quick">Quick Links</h3>
        <div class="quick-links">
          <ul class="quick-links-list">
            <li><a href="index.html" data-i18n="nav.home">Home</a></li>
            <li><a href="directory.html" data-i18n="nav.directory">Directory</a></li>
            <li><a href="events.html" data-i18n="nav.events">Events</a></li>
            <li><a href="bulletin.html" data-i18n="nav.bulletin">Bulletin</a></li>
            <li><a href="get-listed.html" data-i18n="cta.getListed">Get Listed</a></li>
            <li><a href="about.html" data-i18n="nav.about">About</a></li>
            <li><a href="contact.html" data-i18n="nav.contact">Contact</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-section">
        <h3 data-i18n="footer.contactInfo">Connect</h3>
        <p><a href="https://instagram.com/chamber_122_kw"><i class="fab fa-instagram"></i> Instagram</a></p>
        <p><a href="https://www.tiktok.com/@chamber122"><i class="fab fa-tiktok"></i> TikTok</a></p>
        <p><a href="https://wa.me/96522396999"><i class="fab fa-whatsapp"></i> Phone</a></p>
        <p><a href="mailto:info@chamber122.com"><i class="fas fa-envelope"></i> info@chamber122.com</a></p>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>&copy; 2025 Chamber122. All Rights Reserved. | <span data-i18n="footer.empowering">Empowering Kuwait's MSMEs</span></p>
    </div>
  </footer>

  <script src="js/main.js?v=7"></script>
  <script type="module" src="js/activities-list.js"></script>
  <script type="module" src="js/language-switcher.js"></script>
  <script type="module" src="./js/i18n.js"></script>
  <!-- Auth Required Modal -->
  <div id="auth-required-modal" data-testid="auth-required-modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:9999;">
    <div style="width:min(520px,92vw); background:#0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:16px; padding:20px;">
      <h3 style="margin:0 0 8px; font-size:20px;">Login required</h3>
      <p id="auth-required-reason" style="margin:0 0 16px; opacity:.9;">You need to be signed in to continue.</p>
      <div style="display:flex; gap:12px; justify-content:flex-end; flex-wrap:wrap;">
        <button id="events-auth-cancel" data-testid="auth-cancel" style="padding:10px 14px; background:#1a1a1a; border:1px solid #3a3a3a; color:#dcdcdc; border-radius:10px; cursor:pointer;">Cancel</button>
        <button id="auth-guest" data-testid="auth-continue-guest" style="padding:10px 14px; background:#111; border:1px solid #3a3a3a; color:#ffd166; border-radius:10px; cursor:pointer;">Continue as Guest</button>
        <button id="auth-go" data-testid="auth-sign-in" style="padding:10px 14px; background:#ffd166; color:#111; border:none; border-radius:10px; cursor:pointer; font-weight:600;">Sign in</button>
      </div>
    </div>
  </div>

  <!-- Guest Email Prompt -->
  <div id="guest-email-modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:10000;">
    <div style="width:min(420px,92vw); background:#0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:16px; padding:20px;">
      <h3 style="margin:0 0 8px; font-size:18px;">Continue as Guest</h3>
      <p style="margin:0 0 8px; opacity:.9;">Enter your email. Your submission will be <b>reviewed</b> before publishing.</p>
      <input id="events-guest-email-input" data-testid="guest-email-input" type="email" placeholder="you@example.com" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:8px 0;">
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button id="guest-cancel" style="padding:10px 14px; background:#1a1a1a; border:1px solid #3a3a3a; color:#dcdcdc; border-radius:10px; cursor:pointer;">Cancel</button>
        <button id="guest-continue" data-testid="guest-continue-btn" style="padding:10px 14px; background:#ffd166; color:#111; border:none; border-radius:10px; cursor:pointer; font-weight:600;">Continue</button>
      </div>
    </div>
  </div>

  <!-- Event Creation Modal -->
  <div id="event-form-modal" class="event-modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.8); z-index:10000;">
    <div class="event-modal-content" style="width:min(700px,95vw); max-height:90vh; background:#0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:16px; padding:0; overflow:hidden;">
      <!-- Modal Header -->
      <div class="event-modal-header" style="padding:20px; border-bottom:1px solid #2a2a2a; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-size:20px; color:#ffd166;">Create New Event</h3>
        <button id="close-event-modal" style="background:none; border:none; color:#aaa; font-size:24px; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>
      
      <!-- Modal Body -->
      <div class="event-modal-body" style="padding:20px; max-height:70vh; overflow-y:auto;">
        <form id="event-creation-form">
          <!-- Business Selection (for authenticated users) -->
          <div id="business-selection" class="form-group" style="margin-bottom:20px;">
            <label for="event-business" style="display:block; margin-bottom:8px; font-weight:600;">Select Business</label>
            <select id="event-business" name="business_id" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
              <option value="">Loading businesses...</option>
            </select>
          </div>
          
          <!-- Event Type -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-type" style="display:block; margin-bottom:8px; font-weight:600;">Event Type</label>
            <select id="event-type" name="type" required style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
              <option value="">Select event type...</option>
              <option value="networking">Networking</option>
              <option value="training">Training/Workshop</option>
              <option value="promotion">Promotion/Sale</option>
              <option value="market">Market/Fair</option>
              <option value="workshop">Workshop</option>
              <option value="conference">Conference</option>
              <option value="exhibition">Exhibition</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <!-- Event Title -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-title" style="display:block; margin-bottom:8px; font-weight:600;">Event Title *</label>
            <input type="text" id="event-title" name="title" required placeholder="Enter event title..." style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
          </div>
          
          <!-- Event Description -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-description" style="display:block; margin-bottom:8px; font-weight:600;">Description</label>
            <textarea id="event-description" name="description" rows="4" placeholder="Describe your event..." style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px; resize:vertical;"></textarea>
          </div>
          
          <!-- Date and Time -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
            <div class="form-group">
              <label for="event-date" style="display:block; margin-bottom:8px; font-weight:600;">Event Date *</label>
              <input type="date" id="event-date" name="date" required style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            </div>
            <div class="form-group">
              <label for="event-time" style="display:block; margin-bottom:8px; font-weight:600;">Start Time</label>
              <input type="time" id="event-time" name="time" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            </div>
          </div>
          
          <!-- End Date and Time -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
            <div class="form-group">
              <label for="event-end-date" style="display:block; margin-bottom:8px; font-weight:600;">End Date</label>
              <input type="date" id="event-end-date" name="end_date" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            </div>
            <div class="form-group">
              <label for="event-end-time" style="display:block; margin-bottom:8px; font-weight:600;">End Time</label>
              <input type="time" id="event-end-time" name="end_time" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            </div>
          </div>
          
          <!-- Location -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-location" style="display:block; margin-bottom:8px; font-weight:600;">Location</label>
            <input type="text" id="event-location" name="location" placeholder="Enter event location..." style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
          </div>
          
          <!-- Contact Information -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
            <div class="form-group">
              <label for="event-contact" style="display:block; margin-bottom:8px; font-weight:600;">Contact Email</label>
              <input type="email" id="event-contact" name="contact_email" placeholder="contact@example.com" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            </div>
            <div class="form-group">
              <label for="event-phone" style="display:block; margin-bottom:8px; font-weight:600;">Contact Phone</label>
              <input type="tel" id="event-phone" name="contact_phone" placeholder="+965 XXXX XXXX" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            </div>
          </div>
          
          <!-- Website/Link -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-link" style="display:block; margin-bottom:8px; font-weight:600;">Website/Registration Link</label>
            <input type="url" id="event-link" name="link" placeholder="https://example.com" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
          </div>
          
          <!-- Cover Image Upload -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-image" style="display:block; margin-bottom:8px; font-weight:600;">Cover Image</label>
            <input type="file" id="event-image" name="cover_image" accept="image/*" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            <small style="color:#aaa; font-size:12px; margin-top:4px; display:block;">Upload an image to make your event stand out (optional)</small>
          </div>
          
          <!-- Status Message -->
          <div id="event-status-message" style="margin-bottom:20px; padding:12px; border-radius:8px; display:none;"></div>
        </form>
      </div>
      
      <!-- Modal Footer -->
      <div class="event-modal-footer" style="padding:20px; border-top:1px solid #2a2a2a; display:flex; gap:12px; justify-content:flex-end;">
        <button id="cancel-event" style="padding:12px 20px; background:#1a1a1a; border:1px solid #3a3a3a; color:#dcdcdc; border-radius:10px; cursor:pointer; font-weight:500;">Cancel</button>
        <button id="submit-event" style="padding:12px 20px; background:#ffd166; color:#111; border:none; border-radius:10px; cursor:pointer; font-weight:600;">Create Event</button>
      </div>
    </div>
  </div>

  <!-- Suggest Event (Guest) -->
  <div id="suggest-event-modal" data-testid="suggest-event-modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:9998;">
    <div style="width:min(600px,94vw); background:#0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:16px; padding:20px;">
      <h3 style="margin:0 0 8px;">Suggest an Event (Guest)</h3>
      <p style="margin:0 0 12px; opacity:.9;">Your suggestion goes to our team for review before publishing.</p>
      <label>Title</label>
      <input id="se-title" data-testid="suggest-event-title" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:6px 0;">
      <label>Date</label>
      <input id="se-date" data-testid="suggest-event-date" type="date" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:6px 0;">
      <label>Location</label>
      <input id="se-location" data-testid="suggest-event-location" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:6px 0;">
      <label>Description</label>
      <textarea id="se-desc" data-testid="suggest-event-desc" rows="4" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:6px 0;"></textarea>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:10px;">
        <button id="se-cancel" data-testid="suggest-event-cancel" style="padding:10px 14px; background:#1a1a1a; border:1px solid #3a3a3a; color:#dcdcdc; border-radius:10px; cursor:pointer;">Cancel</button>
        <button id="se-submit" data-testid="suggest-event-submit" style="padding:10px 14px; background:#ffd166; color:#111; border:none; border-radius:10px; cursor:pointer; font-weight:600;">Submit for Review</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { startGuest } from '/js/guest.js';

    const authModal = document.getElementById('auth-required-modal');
    const reasonEl  = document.getElementById('auth-required-reason');
    const btnCancel = document.getElementById('auth-cancel');
    const btnGuest  = document.getElementById('auth-guest');
    const btnGo     = document.getElementById('auth-go');

    const guestModal    = document.getElementById('guest-email-modal');
    const guestInput    = document.getElementById('guest-email-input');
    const guestCancel   = document.getElementById('guest-cancel');
    const guestContinue = document.getElementById('guest-continue');

    let _ctx = { reason: '', redirect: location.pathname + location.search, onGuestReady: null };

    window.showAuthRequiredModal = function ({ reason = '', redirect = location.pathname + location.search, onGuestReady = null } = {}) {
      _ctx = { reason, redirect, onGuestReady };
      if (reasonEl) reasonEl.textContent = reason || 'You need to be signed in to continue.';
      authModal.style.display = 'flex';
    };

    function closeAuth() { authModal.style.display = 'none'; }
    function openGuest() { guestModal.style.display = 'flex'; }
    function closeGuest() { guestModal.style.display = 'none'; }

    btnCancel?.addEventListener('click', closeAuth);
    authModal?.addEventListener('click', (e) => { if (e.target === authModal) closeAuth(); });
    btnGo?.addEventListener('click', () => {
      const params = new URLSearchParams({ redirect: _ctx.redirect, reason: _ctx.reason });
      location.href = `/auth.html?${params.toString()}`;
    });

    btnGuest?.addEventListener('click', () => {
      closeAuth();
      openGuest();
      guestInput?.focus();
    });

    guestCancel?.addEventListener('click', closeGuest);
    guestModal?.addEventListener('click', (e) => { if (e.target === guestModal) closeGuest(); });
    guestContinue?.addEventListener('click', () => {
      const email = (guestInput?.value || '').trim();
      try {
        startGuest(email);
        closeGuest();
        if (typeof _ctx.onGuestReady === 'function') _ctx.onGuestReady();
      } catch {
        alert('Please enter a valid email to continue as Guest.');
      }
    });
  </script>

  <script type="module">
    import { isAuthenticated, getCurrentAccountState } from '/js/supabase.js';
    import { isGuestActive } from '/js/guest.js';
    import { sb } from '/js/supabase.js';
    import { openEventForm } from '/js/events.js?v=3';

    const addBtn = document.getElementById('add-event-btn');
    const suggestModal = document.getElementById('suggest-event-modal');
    const seCancel = document.getElementById('se-cancel');
    const seSubmit = document.getElementById('se-submit');

    function openSuggest() { suggestModal.style.display = 'flex'; }
    function closeSuggest() { suggestModal.style.display = 'none'; }

    addBtn?.addEventListener('click', async (e) => {
      e.preventDefault();
      console.log('Add Event button clicked!');
      
      // TEMPORARY: Skip all authentication checks and just open the modal
      console.log('Opening event form directly (bypassing auth checks)');
      openEventForm();
      
      // Original authentication code (commented out for testing)
      /*
      try {
        const authed = await isAuthenticated();
        console.log('Authentication status:', authed);
        
        if (authed) {
          // Check detailed account state
          const { approved, emailVerified, completeness, isFullyLoggedIn, account } = await getCurrentAccountState();
          console.log('Account state:', { approved, emailVerified, completeness, isFullyLoggedIn, account });
          
          if (isFullyLoggedIn) {
            // Fully logged in - open event creation modal
            console.log('Opening event form for fully logged in user');
            openEventForm();
          } else {
            // Not fully logged in - show detailed status message
            let statusMessage = '';
            if (!account) {
              statusMessage = 'Please create your business profile to add events.';
            } else if (!approved) {
              statusMessage = `Your account is ${account.status}. Complete your profile to enable instant publishing.`;
            } else if (!emailVerified) {
              statusMessage = 'Please verify your email address to enable instant publishing.';
            } else if (completeness < 80) {
              statusMessage = `Profile completeness: ${completeness}%. Complete your profile (80%+) to enable instant publishing.`;
            } else {
              statusMessage = 'Complete your profile to enable instant publishing.';
            }
            
            console.log('Showing auth modal with reason:', statusMessage);
            showAuthRequiredModal({
              reason: statusMessage,
              redirect: `/owner-activities.html?tab=events&return=${encodeURIComponent(location.pathname)}`,
              onGuestReady: () => openSuggest()
            });
          }
        } else {
          // Not authenticated - show auth modal
          console.log('User not authenticated, showing auth modal');
          showAuthRequiredModal({
            reason: 'Sign in to add an event, or continue as Guest to suggest one for review.',
            redirect: `/owner-activities.html?tab=events&return=${encodeURIComponent(location.pathname)}`,
            onGuestReady: () => openSuggest()
          });
        }
      } catch (error) {
        console.error('Error in button click handler:', error);
        // Fallback: just try to open the form
        console.log('Fallback: trying to open event form directly');
        openEventForm();
      }
      */
    });

    seCancel?.addEventListener('click', closeSuggest);
    seSubmit?.addEventListener('click', async () => {
      const title = document.getElementById('se-title').value.trim();
      const date  = document.getElementById('se-date').value;
      const loc   = document.getElementById('se-location').value.trim();
      const desc  = document.getElementById('se-desc').value.trim();
      if (!title || !date) return alert('Title and Date are required.');
      if (!isGuestActive()) return alert('Guest email missing. Continue as Guest again.');

      try {
        const guestEmail = localStorage.getItem('ch122_guest_email') || null;
        const { error } = await sb().from('event_suggestions').insert({
          title, date, location: loc, description: desc,
          submitter_email: guestEmail, status: 'pending'
        });
        if (error) throw error;
        closeSuggest();
        alert('Thanks! Your event suggestion was submitted for review.');
      } catch (e) {
        console.error(e);
        alert('Could not submit suggestion. Please try again.');
      }
    });
  </script>

  <!-- Import authentication and gating scripts -->
  <script type="module" src="js/gating.js"></script>
  <script type="module" src="js/modal-login-required.js"></script>
  <script type="module" src="js/guest.js"></script>
  <script type="module" src="js/compliance-guards.js"></script>
  <link rel="stylesheet" href="css/modal.css">
  <link rel="stylesheet" href="css/header.css?v=1">
</body>
</html>

