<!DOCTYPE html>
<html lang="en">
<head>
  <script>
  </script>
  <link rel="stylesheet" href="/css/header.css?v=1">
  <!-- Module imports will be loaded at the bottom -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events & Promotions | Chamber122</title>
  <meta name="description" content="Discover MSME events, promotions, training sessions, and networking opportunities in Kuwait.">
  <link rel="stylesheet" href="css/style.css?v=18">
  <link rel="stylesheet" href="/css/responsive-enhancements.css?v=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" crossorigin="anonymous">
</head>
<body data-type="event">
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo site-logo">
        <img src="images/logo.png" alt="Chamber122 Logo">
      </a>
      <div class="nav-menu">
        <a href="index.html" class="nav-link" data-i18n="nav.home">Home</a>
        <a href="directory.html" class="nav-link" data-i18n="nav.directory">Directory</a>
        <a href="events.html" class="nav-link active" data-i18n="nav.events">Events</a>
        <a href="bulletin.html" class="nav-link" data-i18n="nav.bulletin">Bulletin</a>
        <a href="about.html" class="nav-link" data-i18n="nav.about">About</a>
        <a href="contact.html" class="nav-link" data-i18n="nav.contact">Contact</a>
      </div>
      <div class="nav-actions">
        <!-- Auth slot for session-aware rendering -->
        <span id="auth-slot">
          <a class="btn" href="/auth.html#login">Login</a>
          <a class="btn primary" href="/auth.html#signup">Sign Up &amp; Get Listed</a>
        </span>
      </div>
      <button class="mobile-menu-btn" id="mobile-menu-btn">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="mobile-link">Home</a>
      <a href="directory.html" class="mobile-link">Directory</a>
      <a href="events.html" class="mobile-link">Events</a>
      <a href="bulletin.html" class="mobile-link">Bulletin</a>
      <a href="about.html" class="mobile-link">About</a>
      <a href="contact.html" class="mobile-link">Contact</a>
      <div class="mobile-divider"></div>
      <a href="owner.html" class="mobile-link">
        <i class="fas fa-building"></i>
        My Business
      </a>
      <a href="owner.html" class="mobile-link">
        <i class="fas fa-calendar-alt"></i>
        My Activities
      </a>
      <a href="admin.html" class="mobile-link">
        <i class="fas fa-cog"></i>
        Admin Panel
      </a>
      <div class="mobile-divider"></div>
      <a href="auth.html" class="mobile-link">
        <i class="fas fa-sign-in-alt"></i>
        Login
      </a>
      <a href="get-listed.html" class="mobile-link">
        <i class="fas fa-user-plus"></i>
        Sign Up & Get Listed
      </a>
    </div>
  </nav>

  <!-- Events Header -->
  <section class="events-header">
    <div class="events-hero">
      <h1 data-i18n="page.title">Events & Promotions</h1>
      <p data-i18n="page.subtitle">Discover upcoming events, training sessions, and promotional activities from Kuwait's MSME community</p>
    </div>
    
    <!-- Search and Filter Bar -->
    <div class="filter-container">
      <div class="filter-bar">
        <div class="filter-group">
          <label for="q" data-i18n="search.label">Search Events</label>
          <input type="text" id="q" class="filter-input" placeholder-i18n data-i18n="search.placeholder" placeholder="Search by title, description, or business...">
        </div>
        <div class="filter-group">
          <label for="range" data-i18n="filters.dateRange">Date Range</label>
          <select id="range" class="filter-input">
            <option value="all" data-i18n="filters.allEvents">All Events</option>
            <option value="today">Today</option>
            <option value="upcoming" data-i18n="filters.upcoming">Upcoming</option>
            <option value="past" data-i18n="filters.past">Past Events</option>
          </select>
        </div>
        <div class="filter-group">
          <button id="add-event-btn" class="add-event-btn" data-testid="add-event-btn">
            <i class="fas fa-plus"></i> <span data-i18n="buttons.addEvent">Add Event</span>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Events Actions -->
  <section class="events-actions">
    <!-- Add Event button is now in the filter bar above -->
  </section>

  <!-- Events Grid -->
  <section class="events-grid-section">
    <div class="events-grid" id="events-grid">
      <!-- Events will be populated by JavaScript -->
    </div>
    <!-- Also create the list container that activities.js expects -->
    <div id="activitiesList" class="list" style="display: none;"></div>
    
    <!-- Removed Load More Events button -->
  </section>

  <!-- Calendar View -->
  <section class="events-calendar-section" id="events-calendar-view" style="display: none;">
    <div id="calendar" data-cal="container" class="card" style="max-width: 800px; margin: 0 auto; padding: 20px;">
      <div class="row" style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <button id="calendar-prev" data-cal="prev" aria-label="Previous month" style="padding: 8px 12px; border: 1px solid #333; background: #1a1a1a; color: #fff; border-radius: 6px; cursor: pointer;">‹</button>
        <div id="calendar-month" data-cal="month" style="flex:1;text-align:center;font-weight:700; color: #fff; font-size: 18px;"></div>
        <button id="calendar-next" data-cal="next" aria-label="Next month" style="padding: 8px 12px; border: 1px solid #333; background: #1a1a1a; color: #fff; border-radius: 6px; cursor: pointer;">›</button>
      </div>
      <div id="calendar-grid" data-cal="grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-top: 10px;"></div>
    </div>
  </section>

  <!-- Cross-page CTA: Go to Bulletin -->
  <div class="text-center" style="padding: 2rem 0;">
    <button onclick="window.location.href='bulletin.html'" class="px-8 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-300 shadow-xl hover:shadow-2xl transform hover:-translate-y-1 text-lg cursor-pointer">
      <i class="fas fa-bullhorn mr-2"></i>View Community Bulletins
    </button>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-brand">
        <img src="images/logo.png" alt="Chamber122" />
      </div>
      <div class="footer-section">
        <h3 data-i18n="footer.aboutTitle">Chamber122</h3>
        <p data-i18n="footer.about">Connecting Kuwait's MSMEs with opportunities for growth and success. Join our community today.</p>
      </div>
      
      <div class="footer-section">
        <h3 data-i18n="footer.quick">Quick Links</h3>
        <div class="quick-links">
          <ul class="quick-links-list">
            <li><a href="index.html" data-i18n="nav.home">Home</a></li>
            <li><a href="directory.html" data-i18n="nav.directory">Directory</a></li>
            <li><a href="events.html" data-i18n="nav.events">Events</a></li>
            <li><a href="bulletin.html" data-i18n="nav.bulletin">Bulletin</a></li>
            <li><a href="get-listed.html" data-i18n="cta.getListed">Get Listed</a></li>
            <li><a href="about.html" data-i18n="nav.about">About</a></li>
            <li><a href="contact.html" data-i18n="nav.contact">Contact</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-section">
        <h3 data-i18n="footer.contactInfo">Connect</h3>
        <p><a href="https://instagram.com/chamber_122_kw"><i class="fab fa-instagram"></i> Instagram</a></p>
        <p><a href="https://www.tiktok.com/@chamber122"><i class="fab fa-tiktok"></i> TikTok</a></p>
        <p><a href="https://wa.me/96522396999"><i class="fab fa-whatsapp"></i> Phone</a></p>
        <p><a href="mailto:info@chamber122.com"><i class="fas fa-envelope"></i> info@chamber122.com</a></p>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>&copy; 2025 Chamber122. All Rights Reserved. | <span data-i18n="footer.empowering">Empowering Kuwait's MSMEs</span></p>
    </div>
  </footer>

  <!-- 1. Shared API -->
  <script type="module" src="/js/api.js"></script>
  
  <!-- 2. Shared auth header slot -->
  <script type="module" src="/public/js/header-auth-slot.js"></script>
  
  <!-- 3. Page script -->
  <script type="module" src="/js/events.js"></script>
  
  <!-- 4) i18n and other utilities -->
  <script src="/js/i18n.js?v=1" defer></script>
  <script src="/js/language-switcher.js?v=1" defer></script>
  
  <!-- 5) Gating and modal scripts -->
  <script type="module" src="/js/gating.js"></script>
  <script type="module" src="/js/modal-login-required.js"></script>
  <!-- Auth Required Modal -->
  <div id="auth-required-modal" data-testid="auth-required-modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:9999;">
    <div style="width:min(520px,92vw); background:#0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:16px; padding:20px;">
      <h3 style="margin:0 0 8px; font-size:20px;">Login required</h3>
      <p id="auth-required-reason" style="margin:0 0 16px; opacity:.9;">You need to be signed in to post events or bulletins.</p>
      <div style="display:flex; gap:12px; justify-content:flex-end; flex-wrap:wrap;">
        <button id="events-auth-cancel" data-testid="auth-cancel" style="padding:10px 14px; background:#1a1a1a; border:1px solid #3a3a3a; color:#dcdcdc; border-radius:10px; cursor:pointer;">Cancel</button>
        <button id="auth-go" data-testid="auth-sign-in" style="padding:10px 14px; background:#ffd166; color:#111; border:none; border-radius:10px; cursor:pointer; font-weight:600;">Sign in / Sign up</button>
      </div>
    </div>
  </div>
  
  <script>
    // Setup modal button handlers for auth required modal
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('auth-required-modal');
      const cancelBtn = document.getElementById('events-auth-cancel');
      const signInBtn = document.getElementById('auth-go');
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
        });
      }
      
      if (signInBtn) {
        signInBtn.addEventListener('click', function() {
          const redirect = encodeURIComponent(location.pathname + location.search);
          location.href = `/auth.html?redirect=${redirect}`;
        });
      }
    });
  </script>

  <!-- Guest Email Prompt -->
  <div id="guest-email-modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:10000;">
    <div style="width:min(420px,92vw); background:#0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:16px; padding:20px;">
      <h3 style="margin:0 0 8px; font-size:18px;">Continue as Guest</h3>
      <p style="margin:0 0 8px; opacity:.9;">Enter your email. Your submission will be <b>reviewed</b> before publishing.</p>
      <input id="events-guest-email-input" data-testid="guest-email-input" type="email" placeholder="you@example.com" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:8px 0;">
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button id="guest-cancel" style="padding:10px 14px; background:#1a1a1a; border:1px solid #3a3a3a; color:#dcdcdc; border-radius:10px; cursor:pointer;">Cancel</button>
        <button id="guest-continue" data-testid="guest-continue-btn" style="padding:10px 14px; background:#ffd166; color:#111; border:none; border-radius:10px; cursor:pointer; font-weight:600;">Continue</button>
      </div>
    </div>
  </div>

  <!-- Event Creation Modal -->
  <div id="event-form-modal" class="event-modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.8); z-index:10000;">
    <div class="event-modal-content" style="width:min(700px,95vw); max-height:90vh; background:#0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:16px; padding:0; overflow:hidden; display:flex; flex-direction:column;">
      <!-- Modal Header -->
      <div class="event-modal-header" style="padding:20px; border-bottom:1px solid #2a2a2a; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-size:20px; color:#ffd166;">Create New Event</h3>
        <button id="close-event-modal" style="background:none; border:none; color:#aaa; font-size:24px; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>
      
      <!-- Modal Body -->
      <div class="event-modal-body" style="padding:20px; max-height:60vh; overflow-y:auto; flex:1;">
        <form id="event-creation-form">
          <!-- Business Selection -->
          
          <!-- Event Type -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-type" style="display:block; margin-bottom:8px; font-weight:600;">Event Type</label>
            <select id="event-type" name="type" required style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
              <option value="">Select event type...</option>
              <option value="networking">Networking</option>
              <option value="training">Training/Workshop</option>
              <option value="promotion">Promotion/Sale</option>
              <option value="market">Market/Fair</option>
              <option value="workshop">Workshop</option>
              <option value="conference">Conference</option>
              <option value="exhibition">Exhibition</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <!-- Event Title -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-title" style="display:block; margin-bottom:8px; font-weight:600;">Event Title *</label>
            <input type="text" id="event-title" name="title" required placeholder="Enter event title..." style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
          </div>
          
          <!-- Event Description -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-description" style="display:block; margin-bottom:8px; font-weight:600;">Description</label>
            <textarea id="event-description" name="description" rows="4" placeholder="Describe your event..." style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px; resize:vertical;"></textarea>
          </div>
          
          <!-- Event Image -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-image" style="display:block; margin-bottom:8px; font-weight:600;">Event Image (Optional)</label>
            <input type="file" id="event-image" name="image" accept="image/*" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            <div id="event-image-preview" style="margin-top:12px; display:none;">
              <img id="event-image-preview-img" src="" alt="Preview" style="max-width:100%; max-height:200px; border-radius:8px; border:1px solid #3a3a3a;">
            </div>
          </div>
          
          <!-- Date and Time -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
            <div class="form-group">
              <label for="event-start" style="display:block; margin-bottom:8px; font-weight:600;">Start Date & Time *</label>
              <input type="datetime-local" id="event-start" name="start_at" required style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            </div>
            <div class="form-group">
              <label for="event-end" style="display:block; margin-bottom:8px; font-weight:600;">End Date & Time</label>
              <input type="datetime-local" id="event-end" name="end_at" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            </div>
          </div>
          
          
          <!-- Location -->
          <div class="form-group" style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:8px; font-weight:600;">Location</label>
            
            <!-- Governorate -->
            <div style="margin-bottom:12px;">
              <select id="event-governorate" name="governorate" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
                <option value="">Select Governorate...</option>
                <option value="Al Ahmadi">Al Ahmadi</option>
                <option value="Al Farwaniyah">Al Farwaniyah</option>
                <option value="Al Jahra">Al Jahra</option>
                <option value="Hawalli">Hawalli</option>
                <option value="Kuwait City">Kuwait City</option>
                <option value="Mubarak Al-Kabeer">Mubarak Al-Kabeer</option>
              </select>
            </div>
            
            <!-- Area -->
            <div style="margin-bottom:12px;">
              <select id="event-area" name="area" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
                <option value="">Select Area...</option>
                <option value="Salmiya">Salmiya</option>
                <option value="Hawalli">Hawalli</option>
                <option value="Dasman">Dasman</option>
                <option value="Sharq">Sharq</option>
                <option value="Jibla">Jibla</option>
                <option value="Mirqab">Mirqab</option>
                <option value="Kuwait City">Kuwait City</option>
                <option value="Online">Online</option>
              </select>
            </div>
            
            <!-- Street -->
            <div style="margin-bottom:12px;">
              <input type="text" id="event-street" name="street" placeholder="Street name (optional)" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            </div>
            
            <!-- Office and Floor -->
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
              <div>
                <input type="text" id="event-office" name="office" placeholder="Office number (optional)" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
              </div>
              <div>
                <input type="text" id="event-floor" name="floor" placeholder="Floor (optional)" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
              </div>
            </div>
            
          </div>
          
          <!-- Contact Information -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
            <div class="form-group">
              <label for="event-contact-name" style="display:block; margin-bottom:8px; font-weight:600;">Contact Name</label>
              <input type="text" id="event-contact-name" name="contact_name" placeholder="Your name" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            </div>
            <div class="form-group">
              <label for="event-contact-email" style="display:block; margin-bottom:8px; font-weight:600;">Contact Email</label>
              <input type="email" id="event-contact-email" name="contact_email" placeholder="contact@example.com" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            </div>
          </div>
          
          <!-- Contact Phone -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-contact-phone" style="display:block; margin-bottom:8px; font-weight:600;">Contact Phone</label>
            <input type="tel" id="event-contact-phone" name="contact_phone" placeholder="+965 XXXX XXXX" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
          </div>
          
          <!-- Website/Link -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-link" style="display:block; margin-bottom:8px; font-weight:600;">Website/Registration Link</label>
            <input type="url" id="event-link" name="link" placeholder="https://example.com" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
          </div>
          
          <!-- Cover Image Upload -->
          <div class="form-group" style="margin-bottom:20px;">
            <label for="event-cover" style="display:block; margin-bottom:8px; font-weight:600;">Cover Image</label>
            <input type="file" id="event-cover" name="cover_image" accept="image/*" style="width:100%; padding:12px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; font-size:14px;">
            <small style="color:#aaa; font-size:12px; margin-top:4px; display:block;">Upload an image to make your event stand out (optional)</small>
          </div>
          
          <!-- Error Message -->
          <div id="event-error" style="margin-bottom:20px; padding:12px; border-radius:8px; display:none; background:#ff4444; color:#fff;"></div>
        </form>
      </div>
      
      <!-- Modal Footer -->
      <div class="event-modal-footer" style="padding:20px; border-top:1px solid #2a2a2a; display:flex; gap:12px; justify-content:flex-end;">
        <button id="cancel-event" style="padding:12px 20px; background:#1a1a1a; border:1px solid #3a3a3a; color:#dcdcdc; border-radius:10px; cursor:pointer; font-weight:500;">Cancel</button>
        <button id="event-submit" style="padding:12px 20px; background:#ff0000; color:#fff; border:2px solid #fff; border-radius:10px; cursor:pointer; font-weight:600; font-size:16px;">CREATE EVENT</button>
      </div>
    </div>
  </div>

  <!-- Suggest Event (Guest) -->
  <div id="suggest-event-modal" data-testid="suggest-event-modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:9998;">
    <div style="width:min(600px,94vw); background:#0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:16px; padding:20px;">
      <h3 style="margin:0 0 8px;">Suggest an Event (Guest)</h3>
      <p style="margin:0 0 12px; opacity:.9;">Your suggestion goes to our team for review before publishing.</p>
      <label>Title</label>
      <input id="se-title" data-testid="suggest-event-title" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:6px 0;">
      <label>Date</label>
      <input id="se-date" data-testid="suggest-event-date" type="date" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:6px 0;">
      <label>Location</label>
      <input id="se-location" data-testid="suggest-event-location" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:6px 0;">
      <label>Description</label>
      <textarea id="se-desc" data-testid="suggest-event-desc" rows="4" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:6px 0;"></textarea>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:10px;">
        <button id="se-cancel" data-testid="suggest-event-cancel" style="padding:10px 14px; background:#1a1a1a; border:1px solid #3a3a3a; color:#dcdcdc; border-radius:10px; cursor:pointer;">Cancel</button>
        <button id="se-submit" data-testid="suggest-event-submit" style="padding:10px 14px; background:#ffd166; color:#111; border:none; border-radius:10px; cursor:pointer; font-weight:600;">Submit for Review</button>
      </div>
    </div>
  </div>

  <!-- Auth modal handler -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const authModal = document.getElementById('auth-required-modal');
      const reasonEl  = document.getElementById('auth-required-reason');
      const btnCancel = document.getElementById('auth-cancel');
      const btnGuest  = document.getElementById('auth-guest');
      const btnGo     = document.getElementById('auth-go');

      const guestModal    = document.getElementById('guest-email-modal');
      const guestInput    = document.getElementById('guest-email-input');
      const guestCancel   = document.getElementById('guest-cancel');
      const guestContinue = document.getElementById('guest-continue');

      let _ctx = { reason: '', redirect: location.pathname + location.search, onGuestReady: null };

      window.showAuthRequiredModal = function ({ reason = '', redirect = location.pathname + location.search, onGuestReady = null } = {}) {
        _ctx = { reason, redirect, onGuestReady };
        if (reasonEl) reasonEl.textContent = reason || 'You need to be signed in to continue.';
        if (authModal) authModal.style.display = 'flex';
      };

      function closeAuth() { 
        if (authModal) authModal.style.display = 'none'; 
      }
      function openGuest() { 
        if (guestModal) guestModal.style.display = 'flex'; 
      }
      function closeGuest() { 
        if (guestModal) guestModal.style.display = 'none'; 
      }

      if (btnCancel) {
        btnCancel.addEventListener('click', closeAuth);
      }
      
      if (authModal) {
        authModal.addEventListener('click', (e) => { 
          if (e.target === authModal) closeAuth(); 
        });
      }
      
      if (btnGo) {
        btnGo.addEventListener('click', () => {
          const params = new URLSearchParams({ redirect: _ctx.redirect, reason: _ctx.reason });
          location.href = `/auth.html?${params.toString()}`;
        });
      }

      if (btnGuest) {
        btnGuest.addEventListener('click', () => {
          closeAuth();
          openGuest();
          if (guestInput) guestInput.focus();
        });
      }

      if (guestCancel) {
        guestCancel.addEventListener('click', closeGuest);
      }
      
      if (guestModal) {
        guestModal.addEventListener('click', (e) => { 
          if (e.target === guestModal) closeGuest(); 
        });
      }
      
      if (guestContinue) {
        guestContinue.addEventListener('click', () => {
          const email = (guestInput?.value || '').trim();
          try {
            // Simple guest email storage (replace startGuest import)
            if (email) {
              localStorage.setItem('ch122_guest_email', email);
              closeGuest();
              if (typeof _ctx.onGuestReady === 'function') _ctx.onGuestReady();
            } else {
              alert('Please enter a valid email to continue as Guest.');
            }
          } catch {
            alert('Please enter a valid email to continue as Guest.');
          }
        });
      }
    });
  </script>

  <!-- Event form handler -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const addBtn = document.getElementById('add-event-btn');
      const suggestModal = document.getElementById('suggest-event-modal');
      const seCancel = document.getElementById('se-cancel');
      const seSubmit = document.getElementById('se-submit');

      function openSuggest() { 
        if (suggestModal) suggestModal.style.display = 'flex'; 
      }
      function closeSuggest() { 
        if (suggestModal) suggestModal.style.display = 'none'; 
      }

      if (addBtn) {
        addBtn.addEventListener('click', async function(e) {
          e.preventDefault();
          console.log('Add Event button clicked!');
          
          // Use gateAndRoute from gating.js
          try {
            const { gateAndRoute } = await import('/js/gating.js');
            await gateAndRoute('event');
          } catch (err) {
            console.error('Gating error:', err);
            // Fallback: try to open modal directly if available
            if (window.openEventForm) {
              window.openEventForm();
            } else {
              alert('Please log in to create an event.');
              window.location.href = '/auth.html#login';
            }
          }
        });
      }

      if (seCancel) {
        seCancel.addEventListener('click', closeSuggest);
      }
      
      if (suggestModal) {
        suggestModal.addEventListener('click', function(e) { 
          if (e.target === suggestModal) closeSuggest(); 
        });
      }
      
      if (seSubmit) {
        seSubmit.addEventListener('click', async function() {
          const title = document.getElementById('se-title')?.value?.trim();
          const date = document.getElementById('se-date')?.value;
          const loc = document.getElementById('se-location')?.value?.trim();
          const desc = document.getElementById('se-desc')?.value?.trim();
          
          if (!title || !date) {
            alert('Title and Date are required.');
            return;
          }
          
          try {
            // Event suggestions can be implemented later via API
            // For now, just show a message
            closeSuggest();
            alert('Thanks! Your event suggestion was submitted for review. (Note: This feature is being migrated to the new backend)');
          } catch (e) {
            console.error(e);
            alert('Could not submit suggestion. Please try again.');
          }
        });
      }
    });
  </script>

  <link rel="stylesheet" href="css/modal.css">
  <link rel="stylesheet" href="css/header.css?v=1">
  <script type="module" src="/js/visitor-tracking.js"></script>
</body>
</html>

