<!DOCTYPE html>
<html lang="en" class="dark bg-zinc-900 text-zinc-100">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Guard Test - Chamber122</title>
  <link rel="stylesheet" href="/public/css/dialog.css?v=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .console-log {
      background: #0f1115;
      border: 1px solid #2a2f3a;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid #1a1d2e;
    }
    .log-success { color: #10b981; }
    .log-error { color: #ef4444; }
    .log-info { color: #60a5fa; }
    .log-warn { color: #f59e0b; }
  </style>
</head>
<body class="dark bg-zinc-900 text-zinc-100 min-h-screen p-8">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-white mb-4">üîç Auth Guard Debug Test</h1>
    <p class="text-zinc-400 mb-6">Testing all auth guard components with visible console output</p>

    <!-- Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-zinc-800 p-4 rounded-lg border border-zinc-700">
        <h3 class="text-sm text-zinc-400 mb-2">Supabase Client</h3>
        <p id="status-client" class="text-lg font-semibold">Checking...</p>
      </div>
      <div class="bg-zinc-800 p-4 rounded-lg border border-zinc-700">
        <h3 class="text-sm text-zinc-400 mb-2">Auth Session</h3>
        <p id="status-session" class="text-lg font-semibold">Checking...</p>
      </div>
      <div class="bg-zinc-800 p-4 rounded-lg border border-zinc-700">
        <h3 class="text-sm text-zinc-400 mb-2">Modal Loaded</h3>
        <p id="status-modal" class="text-lg font-semibold">Checking...</p>
      </div>
    </div>

    <!-- Test Buttons -->
    <div class="bg-zinc-800 p-6 rounded-lg border border-zinc-700 mb-6">
      <h2 class="text-xl font-bold mb-4">Test Actions</h2>
      <div class="space-y-3">
        <button id="test-check-session" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-semibold">
          1. Check Current Session
        </button>
        <button id="test-auth-guard" class="w-full bg-primary hover:bg-primary/90 text-white px-4 py-3 rounded-lg font-semibold">
          2. Test Auth Guard (Show Modal if Not Logged In)
        </button>
        <button id="test-clear-session" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-semibold">
          3. Clear Session (Logout)
        </button>
        <a href="/auth.html?redirect=/TEST_AUTH_GUARD.html" class="block w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-3 rounded-lg font-semibold text-center">
          4. Go to Login Page
        </a>
      </div>
    </div>

    <!-- Console Output -->
    <div class="bg-zinc-800 p-6 rounded-lg border border-zinc-700">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Console Output</h2>
        <button id="clear-console" class="bg-zinc-700 hover:bg-zinc-600 text-white px-3 py-1 rounded text-sm">
          Clear
        </button>
      </div>
      <div id="console-output" class="console-log"></div>
    </div>
  </div>

  <!-- Login Required Modal -->
  <div id="login-modal-slot"></div>

  <!-- Scripts -->
  <script type="module">
    // Custom console logger
    const consoleOutput = document.getElementById('console-output');
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      consoleOutput.appendChild(entry);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    console.log = (...args) => {
      originalLog(...args);
      addLog(args.join(' '), 'info');
    };

    console.error = (...args) => {
      originalError(...args);
      addLog(args.join(' '), 'error');
    };

    console.warn = (...args) => {
      originalWarn(...args);
      addLog(args.join(' '), 'warn');
    };

    document.getElementById('clear-console').addEventListener('click', () => {
      consoleOutput.innerHTML = '';
    });

    // Load modal
    (async () => {
      try {
        const r = await fetch('/public/partials/login-required-modal.html');
        const html = await r.text();
        document.getElementById('login-modal-slot').innerHTML = html;
        document.getElementById('status-modal').textContent = '‚úÖ Loaded';
        document.getElementById('status-modal').className = 'text-lg font-semibold text-green-500';
        console.log('‚úÖ Modal HTML loaded successfully');
      } catch (error) {
        document.getElementById('status-modal').textContent = '‚ùå Failed';
        document.getElementById('status-modal').className = 'text-lg font-semibold text-red-500';
        console.error('‚ùå Failed to load modal:', error);
      }
    })();
  </script>

  <script type="module">
    import { supabase } from './public/js/supabase-client.global.js';
    import { requireAuthOrPrompt } from './public/js/auth-guard.js';

    // Check client status
    if (supabase) {
      document.getElementById('status-client').textContent = '‚úÖ Available';
      document.getElementById('status-client').className = 'text-lg font-semibold text-green-500';
      console.log('‚úÖ Supabase client loaded:', {
        url: supabase.supabaseUrl,
        hasAuth: !!supabase.auth
      });
    } else {
      document.getElementById('status-client').textContent = '‚ùå Missing';
      document.getElementById('status-client').className = 'text-lg font-semibold text-red-500';
      console.error('‚ùå Supabase client not available');
    }

    // Check session status
    async function checkSession() {
      try {
        const { data, error } = await supabase.auth.getSession();
        if (error) throw error;
        
        if (data?.session) {
          document.getElementById('status-session').textContent = '‚úÖ Logged In';
          document.getElementById('status-session').className = 'text-lg font-semibold text-green-500';
          console.log('‚úÖ User logged in:', {
            email: data.session.user.email,
            id: data.session.user.id
          });
          return true;
        } else {
          document.getElementById('status-session').textContent = '‚ùå Logged Out';
          document.getElementById('status-session').className = 'text-lg font-semibold text-red-500';
          console.log('‚ÑπÔ∏è No active session');
          return false;
        }
      } catch (error) {
        document.getElementById('status-session').textContent = '‚ùå Error';
        document.getElementById('status-session').className = 'text-lg font-semibold text-red-500';
        console.error('‚ùå Error checking session:', error);
        return false;
      }
    }

    // Initial session check
    checkSession();

    // Test button handlers
    document.getElementById('test-check-session').addEventListener('click', async () => {
      console.log('üîç Checking session...');
      await checkSession();
    });

    document.getElementById('test-auth-guard').addEventListener('click', async () => {
      console.log('üîí Testing auth guard...');
      try {
        const session = await requireAuthOrPrompt();
        console.log('‚úÖ Auth guard passed - user is authenticated:', session.user.email);
        alert('You are authenticated! Session email: ' + session.user.email);
      } catch (error) {
        if (error.message === 'AUTH_REQUIRED') {
          console.log('‚ÑπÔ∏è Auth required - modal should be shown');
        } else {
          console.error('‚ùå Auth guard error:', error);
        }
      }
    });

    document.getElementById('test-clear-session').addEventListener('click', async () => {
      console.log('üö™ Logging out...');
      try {
        await supabase.auth.signOut();
        console.log('‚úÖ Logged out successfully');
        await checkSession();
      } catch (error) {
        console.error('‚ùå Logout error:', error);
      }
    });

    // Listen for auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
      console.log('üîÑ Auth state changed:', event, session?.user?.email || 'no user');
      checkSession();
    });
  </script>
</body>
</html>

