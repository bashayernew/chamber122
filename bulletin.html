<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MSME Bulletin | Chamber122</title>
  <meta name="description" content="Stay updated with community announcements, job postings, and opportunities for MSMEs in Kuwait.">
  <script>
  </script>
  <link rel="stylesheet" href="/css/header.css?v=1">
  <link rel="stylesheet" href="/css/style.css?v=16">
  <link rel="stylesheet" href="/css/modal.css?v=2">
  <link rel="stylesheet" href="/css/responsive-enhancements.css?v=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Module imports will be loaded at the bottom -->
  <!-- Removed js/bulletins.js import - using bulletin/fab.js instead -->
  <style>
    /* Bulletin List Styling */
    .bulletin-list-container {
      display: grid;
      gap: 20px;
      margin-top: 30px;
    }
    
    .bulletin-card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s ease;
    }
    
    .bulletin-card:hover {
      border-color: var(--gold);
      transform: translateY(-2px);
    }
    
    .bulletin-header {
      margin-bottom: 15px;
    }
    
    .bulletin-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .bulletin-type {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      color: white;
    }
    
    .bulletin-date {
      color: #a0a0a0;
      font-size: 0.85rem;
    }
    
    .bulletin-title {
      color: #e0e0e0;
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .bulletin-description {
      color: #c0c0c0;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .bulletin-location,
    .bulletin-deadline {
      color: #a0a0a0;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }
    
    .bulletin-location i,
    .bulletin-deadline i {
      margin-right: 6px;
      color: var(--gold);
    }
    
    .bulletin-details {
      border-top: 1px solid #2a2a2a;
      padding-top: 15px;
      margin-top: 15px;
    }
    
    .bulletin-company {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #a0a0a0;
    }
    
    .company-logo {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      object-fit: cover;
    }
    
    .attachment-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--gold);
      text-decoration: none;
      margin-top: 10px;
      padding: 6px 12px;
      background: rgba(212, 175, 55, 0.1);
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .attachment-link:hover {
      background: rgba(212, 175, 55, 0.2);
    }
    
    .no-bulletins {
      text-align: center;
      color: #a0a0a0;
      padding: 40px;
      font-style: italic;
    }
    
    /* Modal Styling */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #2a2a2a;
      position: relative;
    }
    
    .modal-header h2 {
      margin: 0;
      color: #e0e0e0;
    }
    
    .modal-header p {
      margin: 5px 0 0 0;
      color: #a0a0a0;
      font-size: 0.9rem;
    }
    
    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      color: #a0a0a0;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:hover {
      color: #e0e0e0;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: #e0e0e0;
      font-weight: 500;
    }
    
    .form-input {
      width: 100%;
      padding: 10px 12px;
      background: #0f0f0f;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 0.9rem;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--gold);
    }
    
    .form-help {
      display: block;
      margin-top: 4px;
      color: #a0a0a0;
      font-size: 0.8rem;
    }
    
    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #2a2a2a;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-secondary {
      background: #374151;
      color: #e0e0e0;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .btn-primary {
      background: var(--gold);
      color: #0f0f0f;
    }
    
    .btn-primary:hover {
      background: #e6b800;
    }
    
    /* FAB Styling */
    .floating-action {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 100;
    }
    
    #fabAddBulletin {
      position: fixed !important;
      bottom: 30px !important;
      right: 30px !important;
      z-index: 99999 !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    #bulletinModal {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      background: rgba(0, 0, 0, 0.8) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      z-index: 10000 !important;
    }
    
    #bulletinModal[hidden] {
      display: none !important;
    }
    
    .modal-card {
      background: #1a1a1a !important;
      border: 1px solid #2a2a2a !important;
      border-radius: 12px !important;
      width: 90% !important;
      max-width: 600px !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
      position: relative !important;
      z-index: 10001 !important;
    }
    
    .modal-footer {
      padding: 20px !important;
      border-top: 1px solid #2a2a2a !important;
      display: flex !important;
      gap: 12px !important;
      justify-content: flex-end !important;
    }
    
    .bulletin-grid-section {
      padding: 2rem !important;
      background: var(--dark-bg) !important;
    }
    
    #bulletin-grid {
      display: grid !important;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)) !important;
      gap: 2rem !important;
    }
    
    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        margin: 20px;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      #fabAddBulletin {
        bottom: 20px !important;
        right: 20px !important;
      }
    }
  </style>
</head>
<body data-type="announcement">
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo site-logo">
        <img src="images/logo.png" alt="Chamber122 Logo">
      </a>
      <div class="nav-menu">
        <a href="index.html" class="nav-link" data-i18n="nav.home">Home</a>
        <a href="directory.html" class="nav-link" data-i18n="nav.directory">Directory</a>
        <a href="events.html" class="nav-link" data-i18n="nav.events">Events</a>
        <a href="bulletin.html" class="nav-link active" data-i18n="nav.bulletin">Bulletin</a>
        <a href="communities.html" class="nav-link">Communities</a>
        <a href="about.html" class="nav-link" data-i18n="nav.about">About</a>
        <a href="contact.html" class="nav-link" data-i18n="nav.contact">Contact</a>
      </div>
      <div class="nav-actions">
        <!-- Auth slot for session-aware rendering -->
        <span id="auth-slot">
          <a class="btn" href="/auth.html#login">Login</a>
          <a class="btn primary" href="/auth.html#signup">Sign Up &amp; Get Listed</a>
        </span>
      </div>
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="mobile-link">Home</a>
      <a href="directory.html" class="mobile-link">Directory</a>
      <a href="events.html" class="mobile-link">Events</a>
      <a href="bulletin.html" class="mobile-link">Bulletin</a>
      <a href="about.html" class="mobile-link">About</a>
      <a href="contact.html" class="mobile-link">Contact</a>
      <div class="mobile-divider"></div>
      <a href="owner.html" class="mobile-link">
        <i class="fas fa-building"></i>
        My Business
      </a>
      <a href="owner.html" class="mobile-link">
        <i class="fas fa-calendar-alt"></i>
        My Activities
      </a>
      <a href="admin.html" class="mobile-link">
        <i class="fas fa-cog"></i>
        Admin Panel
      </a>
      <div class="mobile-divider"></div>
      <a href="auth.html" class="mobile-link">
        <i class="fas fa-sign-in-alt"></i>
        Login
      </a>
      <a href="get-listed.html" class="mobile-link">
        <i class="fas fa-user-plus"></i>
        Sign Up & Get Listed
      </a>
    </div>
  </nav>

  <!-- Bulletin Header -->
  <section class="bulletin-header">
    <div class="bulletin-hero">
      <h1 data-i18n="page.title">MSME Bulletin</h1>
      <p data-i18n="page.subtitle">Stay updated with announcements, job postings, training opportunities, and funding information from the MSME community</p>
    </div>
    
    <!-- Search and Filter Bar -->
    <div class="filter-container">
      <div class="filter-bar">
        <div class="filter-group">
          <label for="q" data-i18n="search.label">Search Bulletin</label>
          <input type="text" id="q" class="filter-input" placeholder-i18n data-i18n="search.placeholder" placeholder="Search by title, description, or business...">
        </div>
        <div class="filter-group">
          <label for="range" data-i18n="filters.dateRange">Date Range</label>
          <select id="range" class="filter-input">
            <option value="all" data-i18n="filters.allPosts">All Posts</option>
            <option value="today" data-i18n="filters.today">Today</option>
            <option value="upcoming" data-i18n="filters.upcoming">Upcoming</option>
            <option value="past" data-i18n="filters.past">Past</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- Bulletin Grid -->
  <section class="bulletin-grid-section">
    <div class="bulletin-grid" id="bulletin-grid">
      <!-- Bulletin posts will be populated by JavaScript -->
    </div>

    <!-- Cross-page CTA: Go to Events -->
    <div class="text-center" style="padding: 2rem 0;">
      <button onclick="window.location.href='events.html'" class="px-8 py-4 bg-gradient-to-r from-yellow-400 to-yellow-600 text-black font-bold rounded-xl hover:from-yellow-500 hover:to-yellow-700 transition-all duration-300 shadow-xl hover:shadow-2xl transform hover:-translate-y-1 text-lg cursor-pointer">
        <i class="fas fa-calendar-alt mr-2"></i>View Events & Promotions
      </button>
    </div>
  </section>

  <!-- Required Elements for Bulletin Feature -->
  <div id="bulletinList"></div>
  <button id="fabAddBulletin" class="fab-red" style="position: fixed !important; bottom: 30px !important; right: 30px !important; z-index: 99999 !important; visibility: visible !important; opacity: 1 !important;" aria-label="Add bulletin">
    <i class="fas fa-plus"></i> <span>Add Bulletin</span>
  </button>
  <div id="bulletinModal" hidden>
    <!-- Bulletin Composer Modal Content -->
    <div class="modal-card">
      <div class="modal-header">
        <h2>Create Bulletin</h2>
        <button id="bClose" class="modal-close" aria-label="Close">&times;</button>
      </div>
      
      <div class="modal-body">
        <form id="bulletinForm">
          <div class="form-group">
            <label for="bType">Type *</label>
            <select id="bType" name="type" required>
              <option value="">Select bulletin type...</option>
              <option value="announcement">Announcement</option>
              <option value="job">Job Opportunity</option>
              <option value="training">Training/Workshop</option>
              <option value="funding">Funding Information</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="bTitle">Title *</label>
            <input type="text" id="bTitle" name="title" required placeholder="Enter bulletin title..." maxlength="200">
          </div>
          
          <div class="form-group">
            <label for="bDesc">Description *</label>
            <textarea id="bDesc" name="description" required placeholder="Describe your bulletin in detail..." maxlength="2000"></textarea>
            <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
              <span id="descCount">0</span>/2000 characters
            </small>
          </div>
          
          <div class="form-group">
            <label for="bLoc">Location</label>
            <input type="text" id="bLoc" name="location" placeholder="City or 'Online'" maxlength="100">
          </div>
          
          <div class="form-group">
            <label for="bDeadline">Deadline</label>
            <input type="date" id="bDeadline" name="deadline">
          </div>
          
          <!-- Contact Information -->
          <div class="form-group">
            <label for="bPhone">Phone</label>
            <input type="tel" id="bPhone" name="contact_phone" placeholder="Enter phone number...">
          </div>
          
          <div class="form-group">
            <label for="bEmail">Email</label>
            <input type="email" id="bEmail" name="contact_email" placeholder="Enter email address...">
          </div>
          
          <!-- Location Details -->
          <div class="form-group">
            <label for="bGovernorate">Governorate</label>
            <input type="text" id="bGovernorate" name="governorate" placeholder="Enter governorate...">
          </div>
          
          <div class="form-group">
            <label for="bArea">Area</label>
            <input type="text" id="bArea" name="area" placeholder="Enter area...">
          </div>
          
          <div class="form-group">
            <label for="bStreet">Street</label>
            <input type="text" id="bStreet" name="street" placeholder="Enter street...">
          </div>
          
          <div class="form-group">
            <label for="bBlock">Block</label>
            <input type="text" id="bBlock" name="block" placeholder="Enter block...">
          </div>
          
          <div class="form-group">
            <label for="bFloor">Floor</label>
            <input type="text" id="bFloor" name="floor" placeholder="Enter floor...">
          </div>
          
          <div class="form-group">
            <label for="bFile">Image (Optional)</label>
            <input type="file" id="bFile" name="image" accept="image/png,image/jpg,image/jpeg,image/webp">
            <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
              Supported formats: PNG, JPG, JPEG, WEBP (Max 10MB)
            </small>
            <div id="bImagePreviewContainer" style="margin-top: 10px; display: none;">
              <img id="bImagePreview" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid #2a2a2a;">
              <button type="button" id="bRemoveImage" style="margin-top: 8px; padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove Image</button>
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button id="bCancel" type="button" class="btn btn-secondary">Cancel</button>
        <button id="bPublish" type="button" class="btn btn-primary">Publish</button>
      </div>
    </div>
  </div>
  
  <!-- Bulletin List Container for New Modal System -->
  <div id="bulletins-list" data-bulletins="list"></div>
  
  <!-- Modal Root (script will create if missing) -->
  <div id="modal-root" class="modal-root"></div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-brand">
        <img src="images/logo.png" alt="Chamber122" />
      </div>
      <div class="footer-section">
        <h3 data-i18n="footer.aboutTitle">Chamber122</h3>
        <p data-i18n="footer.about">Connecting Kuwait's MSMEs with opportunities for growth and success. Join our community today.</p>
      </div>
      
      <div class="footer-section">
        <h3 data-i18n="footer.quick">Quick Links</h3>
        <div class="quick-links">
          <ul class="quick-links-list">
            <li><a href="index.html" data-i18n="nav.home">Home</a></li>
            <li><a href="directory.html" data-i18n="nav.directory">Directory</a></li>
            <li><a href="events.html" data-i18n="nav.events">Events</a></li>
            <li><a href="bulletin.html" data-i18n="nav.bulletin">Bulletin</a></li>
            <li><a href="get-listed.html" data-i18n="cta.getListed">Get Listed</a></li>
            <li><a href="about.html" data-i18n="nav.about">About</a></li>
            <li><a href="contact.html" data-i18n="nav.contact">Contact</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-section">
        <h3 data-i18n="footer.contactInfo">Connect</h3>
        <p><a href="https://instagram.com/chamber_122_kw"><i class="fab fa-instagram"></i> Instagram</a></p>
        <p><a href="https://www.tiktok.com/@chamber122"><i class="fab fa-tiktok"></i> TikTok</a></p>
        <p><a href="https://wa.me/96522396999"><i class="fab fa-whatsapp"></i> Phone</a></p>
        <p><a href="mailto:info@chamber122.com"><i class="fas fa-envelope"></i> info@chamber122.com</a></p>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>&copy; 2025 Chamber122. All Rights Reserved. | <span data-i18n="footer.empowering">Empowering Kuwait's MSMEs</span></p>
    </div>
  </footer>

  <!-- 1. Shared API -->
  <script type="module" src="/js/api.js"></script>
  
  <!-- 2. Shared auth header slot -->
  <script type="module" src="/public/js/header-auth-slot.js"></script>
  
  <!-- 3. Page script -->
  <script type="module" src="/js/bulletins.js"></script>
  
  <!-- 4. i18n and other utilities -->
  <script src="/js/i18n.js?v=1"></script>
  <script src="/js/language-switcher.js?v=1"></script>
  
  <!-- Main dependencies -->
  <script type="module" src="/js/main.js?v=7"></script>
  <script type="module" src="/js/visitor-tracking.js"></script>

  <!-- Auth Required Modal -->
  <div id="auth-required-modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:9999;">
    <div style="width:min(520px,92vw); background:#0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:16px; padding:20px;">
      <h3 style="margin:0 0 8px; font-size:20px;">Login required</h3>
      <p id="auth-required-reason" style="margin:0 0 16px; opacity:.9;">You need to be signed in to post events or bulletins.</p>
      <div style="display:flex; gap:12px; justify-content:flex-end; flex-wrap:wrap;">
        <button id="bulletin-auth-cancel" style="padding:10px 14px; background:#1a1a1a; border:1px solid #3a3a3a; color:#dcdcdc; border-radius:10px; cursor:pointer;">Cancel</button>
        <button id="auth-go" style="padding:10px 14px; background:#ffd166; color:#111; border:none; border-radius:10px; cursor:pointer; font-weight:600;">Sign in / Sign up</button>
      </div>
    </div>
  </div>
  
  <script>
    // Setup modal button handlers for auth required modal
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('auth-required-modal');
      const cancelBtn = document.getElementById('bulletin-auth-cancel');
      const signInBtn = document.getElementById('auth-go');
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
        });
      }
      
      if (signInBtn) {
        signInBtn.addEventListener('click', function() {
          const redirect = encodeURIComponent(location.pathname + location.search);
          location.href = `/auth.html?redirect=${redirect}`;
        });
      }
    });
  </script>

  <!-- Guest Email Prompt -->
  <div id="guest-email-modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:10000;">
    <div style="width:min(420px,92vw); background:#0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:16px; padding:20px;">
      <h3 style="margin:0 0 8px; font-size:18px;">Continue as Guest</h3>
      <p style="margin:0 0 8px; opacity:.9;">Enter your email. Your submission will be <b>reviewed</b> before publishing.</p>
      <label for="bulletin-guest-email-input" class="sr-only">Email address</label>
      <input id="bulletin-guest-email-input" type="email" placeholder="you@example.com" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:8px 0;" aria-label="Email address">
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button id="guest-cancel" style="padding:10px 14px; background:#1a1a1a; border:1px solid #3a3a3a; color:#dcdcdc; border-radius:10px; cursor:pointer;">Cancel</button>
        <button id="guest-continue" style="padding:10px 14px; background:#ffd166; color:#111; border:none; border-radius:10px; cursor:pointer; font-weight:600;">Continue</button>
      </div>
    </div>
  </div>

  <!-- Guest Bulletin Modal -->
  <div id="guest-bulletin-modal" data-testid="guest-bulletin-modal" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:9998;">
    <div style="width:min(600px,94vw); background:#0f0f0f; color:#eaeaea; border:1px solid #2a2a2a; border-radius:16px; padding:20px;">
      <h3 style="margin:0 0 8px;">Post to Bulletin (Guest)</h3>
      <p style="margin:0 0 12px; opacity:.9;">Guest posts are reviewed before publishing.</p>
      <label for="gb-title">Title</label>
      <input id="gb-title" data-testid="guest-bulletin-title" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:6px 0;">
      <label for="gb-content">Content</label>
      <textarea id="gb-content" data-testid="guest-bulletin-content" rows="5" style="width:100%; padding:10px; border-radius:10px; border:1px solid #3a3a3a; background:#121212; color:#eee; margin:6px 0;"></textarea>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:10px;">
        <button id="gb-cancel" data-testid="guest-bulletin-cancel" style="padding:10px 14px; background:#1a1a1a; border:1px solid #3a3a3a; color:#dcdcdc; border-radius:10px; cursor:pointer;">Cancel</button>
        <button id="gb-submit" data-testid="guest-bulletin-submit" style="padding:10px 14px; background:#ffd166; color:#111; border:none; border-radius:10px; cursor:pointer; font-weight:600;">Submit for Review</button>
      </div>
    </div>
  </div>

  <!-- Main dependencies -->
  <!-- main.js removed to avoid conflicts -->
  
  <!-- Classic scripts -->
  <script type="module">
    // Load bulletins.js which will initialize the page
    import '/js/bulletins.js';

    const authModal = document.getElementById('auth-required-modal');
    const reasonEl  = document.getElementById('auth-required-reason');
    const btnCancel = document.getElementById('auth-cancel');
    const btnGuest  = document.getElementById('auth-guest');
    const btnGo     = document.getElementById('auth-go');

    const guestModal    = document.getElementById('guest-email-modal');
    const guestInput    = document.getElementById('guest-email-input');
    const guestCancel   = document.getElementById('guest-cancel');
    const guestContinue = document.getElementById('guest-continue');

    let _ctx = { reason: '', redirect: location.pathname + location.search, onGuestReady: null };

    window.showAuthRequiredModal = function ({ reason = '', redirect = location.pathname + location.search, onGuestReady = null } = {}) {
      _ctx = { reason, redirect, onGuestReady };
      if (reasonEl) reasonEl.textContent = reason || 'You need to be signed in to continue.';
      authModal.style.display = 'flex';
    };

    function closeAuth() { authModal.style.display = 'none'; }
    function openGuest() { guestModal.style.display = 'flex'; }
    function closeGuest() { guestModal.style.display = 'none'; }

    btnCancel?.addEventListener('click', closeAuth);
    authModal?.addEventListener('click', (e) => { if (e.target === authModal) closeAuth(); });
    btnGo?.addEventListener('click', () => {
      const params = new URLSearchParams({ redirect: _ctx.redirect, reason: _ctx.reason });
      location.href = `/auth.html?${params.toString()}`;
    });

    btnGuest?.addEventListener('click', () => {
      closeAuth();
      openGuest();
      guestInput?.focus();
    });

    guestCancel?.addEventListener('click', closeGuest);
    guestModal?.addEventListener('click', (e) => { if (e.target === guestModal) closeGuest(); });
    if (guestContinue) {
      guestContinue.addEventListener('click', () => {
        const email = (guestInput?.value || '').trim();
        try {
          // Simple guest email storage (replace startGuest import)
          if (email) {
            localStorage.setItem('ch122_guest_email', email);
            closeGuest();
            if (typeof _ctx.onGuestReady === 'function') _ctx.onGuestReady();
          } else {
            alert('Please enter a valid email to continue as Guest.');
          }
        } catch {
          alert('Please enter a valid email to continue as Guest.');
        }
      });
    }
  </script>

  <link rel="stylesheet" href="/css/modal.css">
  
  <!-- Initialize authentication state -->
</body>
</html>

