<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Login Test</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 600px; margin: 20px auto; padding: 20px; border: 1px solid #333; border-radius: 8px; background: #2a2a2a; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #444; border-radius: 5px; }
        .test-section h3 { margin-top: 0; color: #4CAF50; }
        .success { background: #2d5a2d; border-color: #4CAF50; }
        .error { background: #5a2d2d; border-color: #f44336; }
        .warning { background: #5a5a2d; border-color: #ff9800; }
        input, button { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #555; background: #3a3a3a; color: white; }
        button { background: #007bff; cursor: pointer; border-color: #007bff; }
        button:hover { background: #0056b3; }
        .log { background: #1a1a1a; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
    <script>
        window.SUPABASE_URL = "https://gidbvemmqffogakcepka.supabase.co";
        window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZGJ2ZW1tcWZmb2dha2NlcGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NjI0MTUsImV4cCI6MjA3MjMzODQxNX0.rFFi4gq5ZUApmJM_FM5nfGpcPCHy9FLedVwmJOEzV1w";
    </script>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Comprehensive Login System Test</h1>
        
        <div class="test-section" id="env-test">
            <h3>Environment Check</h3>
            <div id="env-status" class="status info">Checking environment...</div>
        </div>

        <div class="test-section" id="client-test">
            <h3>Supabase Client Test</h3>
            <div id="client-status" class="status info">Testing client initialization...</div>
        </div>

        <div class="test-section" id="login-test">
            <h3>Login Test</h3>
            <form id="loginForm">
                <input type="email" id="email" placeholder="Enter your email" required>
                <input type="password" id="password" placeholder="Enter your password" required>
                <button type="submit">Test Login</button>
            </form>
            <div id="login-status" class="status info">Ready to test login...</div>
        </div>

        <div class="test-section" id="session-test">
            <h3>Session Persistence Test</h3>
            <div id="session-status" class="status info">Testing session persistence...</div>
            <button onclick="testSessionPersistence()">Test Session Persistence</button>
        </div>

        <div class="test-section" id="header-test">
            <h3>Header Integration Test</h3>
            <div id="header-status" class="status info">Testing header integration...</div>
            <button onclick="testHeaderIntegration()">Test Header</button>
        </div>

        <div class="test-section">
            <h3>Debug Log</h3>
            <div id="debug-log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.57.4';

        let supabase;
        let currentSession = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[LOGIN-TEST] ${message}`);
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // Test 1: Environment Check
        function testEnvironment() {
            log('Testing environment variables...');
            
            if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
                updateStatus('env-status', 'âŒ Missing environment variables', 'error');
                log('ERROR: Missing SUPABASE_URL or SUPABASE_ANON_KEY', 'error');
                return false;
            }
            
            updateStatus('env-status', 'âœ… Environment variables loaded', 'success');
            log(`SUPABASE_URL: ${window.SUPABASE_URL}`);
            log(`ANON_KEY: ${window.SUPABASE_ANON_KEY.substring(0, 20)}...`);
            return true;
        }

        // Test 2: Client Initialization
        async function testClient() {
            log('Initializing Supabase client...');
            
            try {
                supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY, {
                    auth: {
                        autoRefreshToken: true,
                        persistSession: true,
                        detectSessionInUrl: true,
                    },
                });
                
                updateStatus('client-status', 'âœ… Supabase client initialized', 'success');
                log('Supabase client created successfully');
                
                // Test initial session
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                if (sessionError) {
                    log(`Session check error: ${sessionError.message}`, 'error');
                } else if (sessionData?.session) {
                    currentSession = sessionData.session;
                    log(`Found existing session for: ${sessionData.session.user.email}`);
                    updateStatus('session-status', `âœ… Existing session found: ${sessionData.session.user.email}`, 'success');
                } else {
                    log('No existing session found');
                    updateStatus('session-status', 'â„¹ï¸ No existing session', 'info');
                }
                
                return true;
            } catch (error) {
                updateStatus('client-status', `âŒ Client initialization failed: ${error.message}`, 'error');
                log(`Client initialization error: ${error.message}`, 'error');
                return false;
            }
        }

        // Test 3: Login Functionality
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                updateStatus('login-status', 'âŒ Please enter both email and password', 'error');
                return;
            }
            
            log(`Attempting login for: ${email}`);
            updateStatus('login-status', 'ðŸ”„ Attempting login...', 'info');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ 
                    email, 
                    password 
                });
                
                if (error) {
                    log(`Login error: ${error.message}`, 'error');
                    updateStatus('login-status', `âŒ Login failed: ${error.message}`, 'error');
                    return;
                }
                
                log(`Login successful: ${JSON.stringify(data, null, 2)}`);
                
                if (data?.session?.user) {
                    currentSession = data.session;
                    updateStatus('login-status', `âœ… Login successful! User: ${data.session.user.email}`, 'success');
                    log(`Session created for user: ${data.session.user.email}`);
                    
                    // Test session persistence immediately
                    setTimeout(testSessionPersistence, 1000);
                } else {
                    updateStatus('login-status', 'âš ï¸ Login successful but no session (email confirmation required?)', 'warning');
                    log('No session returned - email confirmation may be required', 'warning');
                }
                
            } catch (err) {
                log(`Login exception: ${err.message}`, 'error');
                updateStatus('login-status', `âŒ Login failed: ${err.message}`, 'error');
            }
        });

        // Test 4: Session Persistence
        window.testSessionPersistence = async function() {
            log('Testing session persistence...');
            
            try {
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    log(`Session persistence error: ${sessionError.message}`, 'error');
                    updateStatus('session-status', `âŒ Session persistence failed: ${sessionError.message}`, 'error');
                    return;
                }
                
                if (sessionData?.session?.user) {
                    currentSession = sessionData.session;
                    updateStatus('session-status', `âœ… Session persists: ${sessionData.session.user.email}`, 'success');
                    log(`Session persistence confirmed for: ${sessionData.session.user.email}`);
                    
                    // Test localStorage
                    const keys = Object.keys(localStorage).filter(k => k.includes('sb-'));
                    log(`LocalStorage keys: ${keys.join(', ')}`);
                    
                    // Test header integration
                    setTimeout(testHeaderIntegration, 500);
                } else {
                    updateStatus('session-status', 'âŒ No session found', 'error');
                    log('No session found in persistence test', 'error');
                }
                
            } catch (err) {
                log(`Session persistence test error: ${err.message}`, 'error');
                updateStatus('session-status', `âŒ Session test failed: ${err.message}`, 'error');
            }
        };

        // Test 5: Header Integration
        window.testHeaderIntegration = async function() {
            log('Testing header integration...');
            
            try {
                // Simulate what the header would do
                const { data: sessionData } = await supabase.auth.getSession();
                
                if (sessionData?.session?.user) {
                    updateStatus('header-status', `âœ… Header would show: ${sessionData.session.user.email}`, 'success');
                    log(`Header integration test passed - would show user: ${sessionData.session.user.email}`);
                } else {
                    updateStatus('header-status', 'âŒ Header would show login buttons', 'error');
                    log('Header integration test failed - no session for header', 'error');
                }
                
            } catch (err) {
                log(`Header integration test error: ${err.message}`, 'error');
                updateStatus('header-status', `âŒ Header test failed: ${err.message}`, 'error');
            }
        };

        // Utility functions
        window.clearLog = function() {
            document.getElementById('debug-log').textContent = '';
        };

        // Initialize tests
        document.addEventListener('DOMContentLoaded', async () => {
            log('Starting comprehensive login system test...');
            
            if (testEnvironment()) {
                await testClient();
            }
            
            log('Test initialization complete');
        });
    </script>
</body>
</html>
