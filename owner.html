<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    window.SUPABASE_URL = "https://gidbvemmqffogakcepka.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZGJ2ZW1tcWZmb2dha2NlcGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NjI0MTUsImV4cCI6MjA3MjMzODQxNX0.rFFi4gq5ZUApmJM_FM5nfGpcPCHy9FLedVwmJOEzV1w";
  </script>
  <link rel="stylesheet" href="/css/header.css?v=1">
  <script type="module" src="/js/supabase-client.js?v=20"></script>
  <script type="module" src="/js/header-auth-slot.js?v=11"></script>
  <script type="module" src="/js/businesses.api.js?v=1"></script>
  <script type="module" src="/js/business-form.js?v=1"></script>
  <script type="module" src="/js/network-status.js?v=1"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>My Business | Chamber122</title>
  <meta name="description" content="Manage your business listing on Chamber122. Update information, upload new logos, and track your listing status.">
  <meta name="supabase-url" content="https://gidbvemmqffogakcepka.supabase.co">
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZGJ2ZW1tcWZmb2dha2NlcGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NjI0MTUsImV4cCI6MjA3MjMzODQxNX0.rFFi4gq5ZUApmJM_FM5nfGpcPCHy9FLedVwmJOEzV1w">
  <link rel="stylesheet" href="css/style.css?v=16">
  <link rel="stylesheet" href="css/header.css?v=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Global Header -->
  <div id="site-header"></div>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo site-logo">
        <img src="images/logo.png" alt="Chamber122 Logo">

      </a>
      <div class="nav-menu">
        <a href="index.html" class="nav-link" data-i18n="nav.home">Home</a>
        <a href="directory.html" class="nav-link" data-i18n="nav.directory">Directory</a>
        <a href="events.html" class="nav-link" data-i18n="nav.events">Events</a>
        <a href="bulletin.html" class="nav-link" data-i18n="nav.bulletin">Bulletin</a>
        <a href="about.html" class="nav-link" data-i18n="nav.about">About</a>
        <a href="contact.html" class="nav-link" data-i18n="nav.contact">Contact</a>
      </div>
      <div class="nav-actions">
        <!-- Language toggle -->
        <span id="lang-toggle" class="lang-toggle" aria-label="Language">
          <button data-lang="en" class="lang-btn">EN</button> |
          <button data-lang="ar" class="lang-btn">AR</button>
        </span>
        <!-- Auth slot for session-aware header -->
        <span id="auth-slot">
          <a class="btn" href="/auth.html">Login</a>
          <a class="btn primary" href="/auth.html#signup">Sign Up &amp; Get Listed</a>
        </span>
      </div>
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="mobile-link">Home</a>
      <a href="directory.html" class="mobile-link">Directory</a>
      <a href="events.html" class="mobile-link">Events</a>
      <a href="bulletin.html" class="mobile-link">Bulletin</a>
      <a href="about.html" class="mobile-link">About</a>
      <a href="contact.html" class="mobile-link">Contact</a>
      <div class="mobile-divider"></div>
      <a href="owner.html" class="mobile-link">
        <i class="fas fa-building"></i>
        My Business
      </a>
      <a href="owner-activities.html" class="mobile-link">
        <i class="fas fa-calendar-alt"></i>
        My Activities
      </a>
      <a href="admin.html" class="mobile-link">
        <i class="fas fa-cog"></i>
        Admin Panel
      </a>
      <div class="mobile-divider"></div>
      <a href="auth.html" class="mobile-link">
        <i class="fas fa-sign-in-alt"></i>
        Login
      </a>
      <a href="get-listed.html" class="mobile-link">
        <i class="fas fa-user-plus"></i>
        Sign Up & Get Listed
      </a>
    </div>
    </div>
  </nav>

<section class="container max-w-5xl mx-auto px-4 py-10">
  <div class="bg-zinc-900/70 rounded-2xl p-8 shadow">
    <h1 class="text-4xl font-bold mb-2">My Business</h1>
    <p class="text-zinc-300 mb-6">Manage your business listing and keep your information up to date.</p>
    <div id="owner-state" class="text-zinc-400">Loadingâ€¦</div>
    <div id="owner-content" class="mt-6 hidden"></div>
    <div id="owner-cta" class="mt-6 hidden">
      <a href="/owner-form.html" class="inline-block rounded-xl px-5 py-3 bg-amber-500/90 hover:bg-amber-500 text-black font-semibold">
        Complete Your Business Profile
      </a>
    </div>
  </div>
</section>
<script type="module" src="/js/owner.js"></script>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-brand">
        <img src="images/logo.png" alt="Chamber122" />
      </div>
      <div class="footer-section">
        <h3>Chamber122</h3>
        <p>Connecting Kuwait's MSMEs with opportunities for growth and success. Join our community today.</p>
      </div>
      
      <div class="footer-section">
        <h3>Quick Links</h3>
        <div class="quick-links">
          <ul class="quick-links-list">
            <li><a href="index.html">Home</a></li>
            <li><a href="directory.html">Directory</a></li>
            <li><a href="events.html">Events</a></li>
            <li><a href="bulletin.html">Bulletin</a></li>
            <li><a href="get-listed.html">Get Listed</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-section">
        <h3>Connect</h3>
        <p><a href="https://instagram.com/chamber_122_kw"><i class="fab fa-instagram"></i> Instagram</a></p>
        <p><a href="https://www.tiktok.com/@chamber122"><i class="fab fa-tiktok"></i> TikTok</a></p>
        <p><a href="https://wa.me/96522396999"><i class="fab fa-whatsapp"></i> Phone</a></p>
        <p><a href="mailto:info@chamber122.com"><i class="fas fa-envelope"></i> info@chamber122.com</a></p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 Chamber122. All Rights Reserved. | Empowering Kuwait's MSMEs</p>
    </div>
  </footer>

  <script src="js/main.js?v=7"></script>
  <script type="module" src="./js/i18n.js"></script>
  <script type="module" src="js/config.js"></script>
  <script type="module" src="js/supabase-client.js"></script>
  <script type="module" src="js/auth-state-manager.js"></script>
  <script type="module" src="js/compliance-banner.js"></script>
  <script type="module" src="js/notification-system.js"></script>
  <script type="module" src="js/owner.js"></script>
  
  <!-- Auth Guard -->
  <script type="module">
    import { requireAuth } from '/shared/auth-guard.js';
    const user = await requireAuth(); // redirects if not logged in
  </script>

  <!-- Profile Completion Form Handler -->
  <script type="module">
    import { supabase } from '/js/supabase-client.js';
    
    // Show the form when no businesses are found
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        // Check if user has any businesses
        const { data: businesses, error } = await supabase
          .from('businesses')
          .select('*')
          .eq('owner_user_id', user.id);

        if (error) {
          console.error('Error fetching businesses:', error);
          return;
        }

        // If no businesses found, show the form
        if (!businesses || businesses.length === 0) {
          document.getElementById('no-businesses').style.display = 'block';
        }
      } catch (error) {
        console.error('Error checking businesses:', error);
      }
    });

    // Handle form submission
    document.getElementById('msme-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const statusEl = document.getElementById('form-status');
      
      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
      
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          throw new Error('User not authenticated');
        }

        // Get form data
        const formData = new FormData(e.target);
        const businessData = {
          owner_user_id: user.id,
          business_name: formData.get('businessName'),
          owner_name: formData.get('ownerName'),
          email: formData.get('email'),
          phone: formData.get('phone'),
          category: formData.get('category'),
          city: formData.get('city'),
          country: formData.get('country'),
          description: formData.get('description'),
          story: formData.get('story'),
          website: formData.get('website') || null,
          instagram: formData.get('instagram') || null,
          status: 'pending' // Will be reviewed by admin
        };

        // Insert business record
        const { data: business, error: businessError } = await supabase
          .from('businesses')
          .insert(businessData)
          .select()
          .single();

        if (businessError) {
          throw businessError;
        }

        // Handle file uploads if any
        const logoFile = formData.get('logo');
        if (logoFile && logoFile.size > 0) {
          const logoExt = logoFile.name.split('.').pop();
          const logoPath = `businesses/${user.id}/${business.id}/logo.${logoExt}`;
          
          const { error: uploadError } = await supabase.storage
            .from('business-assets')
            .upload(logoPath, logoFile);

          if (!uploadError) {
            const { data: logoUrl } = supabase.storage
              .from('business-assets')
              .getPublicUrl(logoPath);
            
            await supabase
              .from('businesses')
              .update({ logo_url: logoUrl.publicUrl })
              .eq('id', business.id);
          }
        }

        // Success message
        statusEl.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; margin: 10px 0;"><i class="fas fa-check-circle"></i> Profile submitted successfully! You will be notified once it\'s approved.</div>';
        
        // Hide the form and show success
        e.target.style.display = 'none';
        
        // Refresh the page after 3 seconds
        setTimeout(() => {
          location.reload();
        }, 3000);

      } catch (error) {
        console.error('Form submission error:', error);
        statusEl.innerHTML = `<div style="color: red; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; margin: 10px 0;"><i class="fas fa-exclamation-circle"></i> Error: ${error.message}</div>`;
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Complete Profile & Submit Listing';
      }
    });
  </script>
</body>
</html>
