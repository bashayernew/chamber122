<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>My Business | Chamber122</title>
  <meta name="description" content="Manage your business listing on Chamber122. Update information, upload new logos, and track your listing status.">
  
  <meta name="supabase-url" content="https://gidbvemmqffogakcepka.supabase.co">
  <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpZGJ2ZW1tcWZmb2dha2NlcGthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NjI0MTUsImV4cCI6MjA3MjMzODQxNX0.rFFi4gq5ZUApmJM_FM5nfGpcPCHy9FLedVwmJOEzV1w">
  <link rel="stylesheet" href="css/style.css?v=16">
  <link rel="stylesheet" href="css/header.css?v=1">
  <link rel="stylesheet" href="public/css/main.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    .tab{background:#0f0f0f;color:#ddd;padding:.5rem .8rem;border-radius:.6rem}
    .tab.active{background:#1a1a1a;color:#fff;border:1px solid #333}
    .tab-pane.hidden{display:none}
  </style>
</head>
<body data-page="owner">
  <!-- Global Header -->
  <div id="site-header"></div>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="logo site-logo">
        <img src="images/logo.png" alt="Chamber122 Logo">

      </a>
      <div class="nav-menu">
        <a href="index.html" class="nav-link" data-i18n="nav.home">Home</a>
        <a href="directory.html" class="nav-link" data-i18n="nav.directory">Directory</a>
        <a href="events.html" class="nav-link" data-i18n="nav.events">Events</a>
        <a href="bulletin.html" class="nav-link" data-i18n="nav.bulletin">Bulletin</a>
        <a href="about.html" class="nav-link" data-i18n="nav.about">About</a>
        <a href="contact.html" class="nav-link" data-i18n="nav.contact">Contact</a>
      </div>
      <div class="nav-actions">
        <!-- Language toggle -->
        <span id="lang-toggle" class="lang-toggle" aria-label="Language">
          <button data-lang="en" class="lang-btn">EN</button> |
          <button data-lang="ar" class="lang-btn">AR</button>
        </span>
        <!-- Auth slot for session-aware header -->
        <span id="auth-slot">
          <a class="btn" href="/auth.html#login">Login</a>
          <a class="btn primary" href="/auth.html#signup">Sign Up &amp; Get Listed</a>
        </span>
      </div>
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="mobile-menu" id="mobile-menu">
      <a href="index.html" class="mobile-link">Home</a>
      <a href="directory.html" class="mobile-link">Directory</a>
      <a href="events.html" class="mobile-link">Events</a>
      <a href="bulletin.html" class="mobile-link">Bulletin</a>
      <a href="about.html" class="mobile-link">About</a>
      <a href="contact.html" class="mobile-link">Contact</a>
      <div class="mobile-divider"></div>
      <a href="owner.html" class="mobile-link">
        <i class="fas fa-building"></i>
        My Business
      </a>
      <a href="owner.html" class="mobile-link">
        <i class="fas fa-calendar-alt"></i>
        My Activities
      </a>
      <a href="admin.html" class="mobile-link">
        <i class="fas fa-cog"></i>
        Admin Panel
      </a>
      <div class="mobile-divider"></div>
      <a href="auth.html" class="mobile-link">
        <i class="fas fa-sign-in-alt"></i>
        Login
      </a>
      <a href="get-listed.html" class="mobile-link">
        <i class="fas fa-user-plus"></i>
        Sign Up & Get Listed
      </a>
    </div>
    </div>
  </nav>

<!-- PROFILE: VIEW MODE -->
<section class="container profile-wrap">
  <div class="profile-header card">
    <div class="avatar-wrap">
      <img id="biz-logo" alt="Business Logo" class="avatar" />
    </div>
    <div class="title-wrap">
      <h1 id="biz-name" class="title">Business Profile</h1>
      <div class="title-row">
        <span id="status-badge" class="badge">pending</span>
        <span id="visibility-badge" class="chip">No (draft)</span>
        <span id="last-updated" class="muted"></span>
      </div>
    </div>
    <div class="actions">
      <a id="edit-link" href="/owner-form.html" class="btn btn-primary">Edit Profile</a>
    </div>
  </div>

  <div class="card">
    <h2 class="section-title">Business Description</h2>
    <div id="description" class="description-text"></div>
  </div>

  <div class="card">
    <h2 class="section-title">Our Story</h2>
    <div id="story" class="story-text"></div>
  </div>

  <div class="card">
    <h2 class="section-title">Contact & Location</h2>
    <div class="details-grid">
      <div><span class="label">Phone</span><a id="phone" class="value" href="#"></a></div>
      <div><span class="label">WhatsApp</span><a id="whatsapp" class="value" href="#"></a></div>
      <div><span class="label">Website</span><a id="website" class="value" href="#" target="_blank" rel="noopener"></a></div>
      <div><span class="label">Instagram</span><a id="instagram" class="value" href="#" target="_blank" rel="noopener"></a></div>

      <div><span class="label">Country</span><span id="country" class="value"></span></div>
      <div><span class="label">City</span><span id="city" class="value"></span></div>
      <div><span class="label">Area</span><span id="area" class="value"></span></div>
      <div><span class="label">Block</span><span id="block" class="value"></span></div>
      <div><span class="label">Street</span><span id="street" class="value"></span></div>
      <div><span class="label">Floor</span><span id="floor" class="value"></span></div>
      <div><span class="label">Office No</span><span id="office_no" class="value"></span></div>

      <div class="full"><span class="label">Industry</span><span id="industry" class="value"></span></div>
    </div>
  </div>

  <section class="card">
    <h3 class="section-title">Gallery</h3>
    <div id="gallery" class="gallery-grid"></div>
  </section>

  <section class="card mt-8">
    <h2 class="section-title">Events</h2>
    <div class="tabs mb-4 flex gap-2">
      <button class="tab active" data-tab="ev-all">All</button>
      <button class="tab" data-tab="ev-ongoing">Ongoing</button>
      <button class="tab" data-tab="ev-upcoming">Upcoming</button>
      <button class="tab" data-tab="ev-previous">Previous</button>
    </div>
    <div id="ev-all" class="tab-pane"></div>
    <div id="ev-ongoing" class="tab-pane hidden"></div>
    <div id="ev-upcoming" class="tab-pane hidden"></div>
    <div id="ev-previous" class="tab-pane hidden"></div>
  </section>

  <section class="card mt-8">
    <h2 class="section-title">Bulletins</h2>
    <div class="tabs mb-4 flex gap-2">
      <button class="tab active" data-tab="bl-all">All</button>
      <button class="tab" data-tab="bl-ongoing">Ongoing</button>
      <button class="tab" data-tab="bl-upcoming">Upcoming</button>
      <button class="tab" data-tab="bl-previous">Previous</button>
    </div>
    <div id="bl-all" class="tab-pane"></div>
    <div id="bl-ongoing" class="tab-pane hidden"></div>
    <div id="bl-upcoming" class="tab-pane hidden"></div>
    <div id="bl-previous" class="tab-pane hidden"></div>
  </section>

  <!-- Registrations Section (Owner Only) -->
  <section class="card mt-8 owner-only" id="registrations-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
      <h2 class="section-title" style="margin: 0;">Registrations</h2>
      <span id="registrations-count" style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">0</span>
    </div>
    <p style="color: #AFAFAF; margin-bottom: 20px;">View and manage registrations for your events and bulletin responses.</p>
    
    <div class="tabs mb-4 flex gap-2">
      <button class="tab active" data-tab="reg-all">All</button>
      <button class="tab" data-tab="reg-events">Events</button>
      <button class="tab" data-tab="reg-bulletins">Bulletins</button>
      <button class="tab" data-tab="reg-pending">Pending</button>
    </div>
    
    <div id="reg-all" class="tab-pane">
      <div id="registrations-all"></div>
    </div>
    <div id="reg-events" class="tab-pane hidden">
      <div id="registrations-events"></div>
    </div>
    <div id="reg-bulletins" class="tab-pane hidden">
      <div id="registrations-bulletins"></div>
    </div>
    <div id="reg-pending" class="tab-pane hidden">
      <div id="registrations-pending"></div>
    </div>
  </section>
</section>
<!-- View-mode logic -->
  <!-- Main dependencies -->
  <script src="/js/main.js?v=7"></script>

  <script type="module">
    import { loadOwnerEventsAndBulletins } from '/assets/js/profile-events.js';
    import { renderList, eventCard, bulletinCard } from '/assets/js/ui-cards.js';
    import { supabase } from '/assets/js/supabase-client.global.js';
    import '/assets/js/refresh-displays.js';

    // Determine which owner profile we're viewing
    // First check URL parameter for businessId (for viewing other businesses)
    const urlParams = new URLSearchParams(window.location.search);
    const businessIdFromUrl = urlParams.get('businessId');
    
    let ownerId = businessIdFromUrl || window.OWNER_ID || window.currentOwnerId;
    
    // If no owner ID set, get from current user's business
    if (!ownerId) {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        try {
          // Use maybeSingle to handle "no rows" gracefully
          const { data: business, error: bizError } = await supabase
          .from('businesses')
          .select('id')
          .eq('owner_id', user.id)
            .maybeSingle();
          
          if (bizError && bizError.code !== 'PGRST116') {
            // Not a "no rows" error - log it
            console.error('[owner] Error fetching business ID:', bizError);
          }
          
          if (business) {
            ownerId = business.id;
          } else {
            // No business found - redirect to form page
            console.log('[owner] No business found for user, redirecting to form');
            if (confirm('No business profile found. Would you like to create one?')) {
              window.location.href = '/owner-form.html';
            }
            // Exit early - don't continue initialization
            ownerId = null;
          }
        } catch (err) {
          console.error('[owner] Exception fetching business:', err);
        }
      }
    }

    // Tab behavior
    function wireTabs() {
      document.querySelectorAll('.tabs .tab').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const group = btn.closest('section');
          group.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const target = btn.dataset.tab;
          group.querySelectorAll('.tab-pane').forEach(p=>p.classList.add('hidden'));
          group.querySelector(`#${target}`)?.classList.remove('hidden');
        });
      });
    }

    let isOwnerViewing = false; // Store isOwner in outer scope for real-time updates

    async function init() {
      // If still no ownerId after all checks, show message and exit
      if (!ownerId) {
        console.warn('[owner] No ownerId available, cannot load profile');
        document.body.innerHTML = '<div style="padding: 40px; text-align: center; color: #AFAFAF;"><h2>No Business Profile</h2><p>Please create a business profile first.</p><a href="/owner-form.html" style="color: #f2c64b;">Create Profile</a></div>';
        return; // Exit early - this is valid inside a function
      }
      
      wireTabs();

      const { data: { user } } = await supabase.auth.getUser();
      // Check if current user owns the business being viewed
      let isOwner = false;
      if (user && ownerId) {
        const { data: business } = await supabase
          .from('businesses')
          .select('owner_id')
          .eq('id', ownerId)
          .single();
        isOwner = business && business.owner_id === user.id;
      }
      isOwnerViewing = isOwner; // Store in outer scope
      if (!isOwner) document.querySelectorAll('.owner-only').forEach(el=>el.remove());

      // Load events and bulletins - pass isOwner flag to show drafts if viewing own profile
      if (ownerId) {
        console.log('[owner] Loading events and bulletins for business ID:', ownerId, 'isOwner:', isOwner);
        try {
      const data = await loadOwnerEventsAndBulletins(ownerId, isOwner);

          console.log('[owner] Loaded data:', {
            eventsOngoing: data.events.ongoing?.length || 0,
            eventsUpcoming: data.events.upcoming?.length || 0,
            eventsPrevious: data.events.previous?.length || 0,
            bulletinsOngoing: data.bulletins.ongoing?.length || 0,
            bulletinsUpcoming: data.bulletins.upcoming?.length || 0,
            bulletinsPrevious: data.bulletins.previous?.length || 0
          });

          // Show registration buttons for non-owners viewing the profile
          const showReg = !isOwner;
          
          // Combine all events for "All" tab
          const allEvents = [...data.events.ongoing, ...data.events.upcoming, ...data.events.previous];
          renderList(document.getElementById('ev-all'), allEvents, (e) => eventCard(e, showReg), 'No events.');
          
          renderList(document.getElementById('ev-ongoing'),  data.events.ongoing,  (e) => eventCard(e, showReg), 'No ongoing events.');
          renderList(document.getElementById('ev-upcoming'), data.events.upcoming, (e) => eventCard(e, showReg), 'No upcoming events.');
          renderList(document.getElementById('ev-previous'), data.events.previous, (e) => eventCard(e, false), 'No previous events.');

          // Combine all bulletins for "All" tab
          const allBulletins = [...data.bulletins.ongoing, ...data.bulletins.upcoming, ...data.bulletins.previous];
          renderList(document.getElementById('bl-all'), allBulletins, (b) => bulletinCard(b, showReg), 'No bulletins.');
          
          renderList(document.getElementById('bl-ongoing'), data.bulletins.ongoing, (b) => bulletinCard(b, showReg), 'No ongoing bulletins.');
          renderList(document.getElementById('bl-upcoming'), data.bulletins.upcoming, (b) => bulletinCard(b, showReg), 'No upcoming bulletins.');
          renderList(document.getElementById('bl-previous'), data.bulletins.previous, (b) => bulletinCard(b, false), 'No previous bulletins.');
        } catch (error) {
          console.error('[owner] Error loading events/bulletins:', error);
        }
      } else {
        console.log('[owner] No ownerId found, cannot load events/bulletins');
        // Show message to user
        const evContainer = document.getElementById('ev-ongoing');
        const blContainer = document.getElementById('bl-ongoing');
        if (evContainer) {
          evContainer.innerHTML = '<p style="text-align: center; color: #AFAFAF; padding: 20px;">Please create a business profile first.</p>';
        }
        if (blContainer) {
          blContainer.innerHTML = '<p style="text-align: center; color: #AFAFAF; padding: 20px;">Please create a business profile first.</p>';
        }
      }

      // Load registrations if owner is viewing own profile
      if (isOwner && ownerId) {
        try {
          const { loadRegistrations, renderRegistrations } = await import('/assets/js/registrations.js');
          
          // Wire up registration tabs
          function wireRegistrationTabs() {
            const regSection = document.getElementById('registrations-section');
            if (!regSection) return;
            
            regSection.querySelectorAll('.tabs .tab').forEach(btn => {
              btn.addEventListener('click', () => {
                const group = regSection;
                group.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const target = btn.dataset.tab;
                group.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
                group.querySelector(`#${target}`)?.classList.remove('hidden');
              });
            });
          }

          wireRegistrationTabs();

          // Load and display registrations
          const regData = await loadRegistrations();
          
          // Update count
          const countEl = document.getElementById('registrations-count');
          if (countEl) {
            const totalCount = regData.all.length;
            countEl.textContent = totalCount;
            countEl.style.display = totalCount > 0 ? 'inline-block' : 'none';
          }

          // Render all registrations
          renderRegistrations(document.getElementById('registrations-all'), regData.all);
          renderRegistrations(document.getElementById('registrations-events'), regData.events);
          renderRegistrations(document.getElementById('registrations-bulletins'), regData.bulletins);
          
          // Render pending
          const pending = regData.all.filter(r => r.status === 'pending');
          renderRegistrations(document.getElementById('registrations-pending'), pending);

          // Make reload function available globally
          window.reloadRegistrations = async () => {
            const regData = await loadRegistrations();
            const countEl = document.getElementById('registrations-count');
            if (countEl) {
              const totalCount = regData.all.length;
              countEl.textContent = totalCount;
              countEl.style.display = totalCount > 0 ? 'inline-block' : 'none';
            }
            renderRegistrations(document.getElementById('registrations-all'), regData.all);
            renderRegistrations(document.getElementById('registrations-events'), regData.events);
            renderRegistrations(document.getElementById('registrations-bulletins'), regData.bulletins);
            const pending = regData.all.filter(r => r.status === 'pending');
            renderRegistrations(document.getElementById('registrations-pending'), pending);
          };
        } catch (error) {
          console.error('[owner] Error loading registrations:', error);
        }
      }
      
      // Setup real-time updates for profile, events, bulletins, and registrations
      if (ownerId) {
        setupRealtimeProfileUpdates(ownerId);
      }
    }

    // Setup real-time updates for profile viewing
    function setupRealtimeProfileUpdates(businessId) {
      // Subscribe to business updates
      const businessChannel = supabase
        .channel(`business-profile:${businessId}`)
        .on(
          'postgres_changes',
          {
            event: 'UPDATE',
            schema: 'public',
            table: 'businesses',
            filter: `id=eq.${businessId}`
          },
          (payload) => {
            console.log('[owner] Business updated via real-time:', payload);
            // Reload the page to show updated data
            window.location.reload();
          }
        )
        .subscribe();
      
      // Subscribe to events
      const eventsChannel = supabase
        .channel(`profile-events:${businessId}`)
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'events',
            filter: `business_id=eq.${businessId}`
          },
          async (payload) => {
            console.log('[owner] Event changed:', payload);
            // Reload events
            const data = await loadOwnerEventsAndBulletins(businessId, isOwnerViewing);
            const showReg = !isOwnerViewing;
            
            // Combine all events for "All" tab
            const allEvents = [...data.events.ongoing, ...data.events.upcoming, ...data.events.previous];
            renderList(document.getElementById('ev-all'), allEvents, (e) => eventCard(e, showReg), 'No events.');
            
            renderList(document.getElementById('ev-ongoing'),  data.events.ongoing,  (e) => eventCard(e, showReg), 'No ongoing events.');
            renderList(document.getElementById('ev-upcoming'), data.events.upcoming, (e) => eventCard(e, showReg), 'No upcoming events.');
            renderList(document.getElementById('ev-previous'), data.events.previous, (e) => eventCard(e, false), 'No previous events.');
          }
        )
        .subscribe();
      
      // Subscribe to bulletins
      const bulletinsChannel = supabase
        .channel(`profile-bulletins:${businessId}`)
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'bulletins',
            filter: `business_id=eq.${businessId}`
          },
          async (payload) => {
            console.log('[owner] Bulletin changed:', payload);
            // Reload bulletins
            const data = await loadOwnerEventsAndBulletins(businessId, isOwnerViewing);
            const showReg = !isOwnerViewing;
            
            // Combine all bulletins for "All" tab
            const allBulletins = [...data.bulletins.ongoing, ...data.bulletins.upcoming, ...data.bulletins.previous];
            renderList(document.getElementById('bl-all'), allBulletins, (b) => bulletinCard(b, showReg), 'No bulletins.');
            
            renderList(document.getElementById('bl-ongoing'), data.bulletins.ongoing, (b) => bulletinCard(b, showReg), 'No ongoing bulletins.');
            renderList(document.getElementById('bl-upcoming'), data.bulletins.upcoming, (b) => bulletinCard(b, showReg), 'No upcoming bulletins.');
            renderList(document.getElementById('bl-previous'), data.bulletins.previous, (b) => bulletinCard(b, false), 'No previous bulletins.');
          }
        )
        .subscribe();
      
      // Subscribe to registrations - reload when new registrations are added
      // Note: We can't filter by business_id in the subscription, so we'll reload all and filter client-side
      const registrationsChannel = supabase
        .channel(`profile-registrations:${businessId}`)
        .on(
          'postgres_changes',
          {
            event: '*', // Listen to INSERT, UPDATE, DELETE
            schema: 'public',
            table: 'registrations'
          },
          async (payload) => {
            console.log('[owner] Registration change detected:', payload);
            // Reload registrations if owner is viewing their own profile
            if (isOwnerViewing && window.reloadRegistrations) {
              console.log('[owner] Reloading registrations after change...');
              setTimeout(() => window.reloadRegistrations(), 500); // Small delay to ensure DB is updated
            }
          }
        )
        .subscribe();
    }

    // Registration functions for events and bulletins
    window.registerForEvent = async function(eventId) {
      try {
        const name = prompt('Enter your name:');
        if (!name) return;
        
        const email = prompt('Enter your email:');
        if (!email) return;
        
        const phone = prompt('Enter your phone (optional):') || null;
        
        const { data, error } = await supabase
          .from('registrations')
          .insert({
            type: 'event',
            item_id: eventId,
            name: name,
            email: email,
            phone: phone,
            status: 'pending'
          })
          .select()
          .single();
        
        if (error) {
          // Handle case where registrations table might not exist
          if (error.code === '42P01' || error.message?.includes('does not exist')) {
            console.error('Registrations table does not exist:', error);
            alert('Registration feature is not available yet. Please contact the organizer directly.');
            return;
          }
          throw error;
        }
        
        console.log('[registration] Event registration created:', data);
        alert('Registration submitted successfully! The organizer will contact you soon.');
        
        // If owner is viewing their own profile, reload registrations
        if (isOwnerViewing && window.reloadRegistrations) {
          setTimeout(() => window.reloadRegistrations(), 1000);
        }
      } catch (error) {
        console.error('Registration error:', error);
        alert('Failed to register: ' + (error.message || 'Unknown error'));
      }
    };
    
    window.registerForBulletin = async function(bulletinId) {
      try {
        const name = prompt('Enter your name:');
        if (!name) return;
        
        const email = prompt('Enter your email:');
        if (!email) return;
        
        const phone = prompt('Enter your phone (optional):') || null;
        
        const { data, error } = await supabase
          .from('registrations')
          .insert({
            type: 'bulletin',
            item_id: bulletinId,
            name: name,
            email: email,
            phone: phone,
            status: 'pending'
          })
          .select()
          .single();
        
        if (error) {
          // Handle case where registrations table might not exist
          if (error.code === '42P01' || error.message?.includes('does not exist')) {
            console.error('Registrations table does not exist:', error);
            alert('Registration feature is not available yet. Please contact the organizer directly.');
            return;
          }
          throw error;
        }
        
        console.log('[registration] Bulletin registration created:', data);
        alert('Response submitted successfully! The organizer will contact you soon.');
        
        // If owner is viewing their own profile, reload registrations
        if (isOwnerViewing && window.reloadRegistrations) {
          setTimeout(() => window.reloadRegistrations(), 1000);
        }
      } catch (error) {
        console.error('Registration error:', error);
        alert('Failed to respond: ' + (error.message || 'Unknown error'));
      }
    };

    init();
  </script>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-brand">
        <img src="images/logo.png" alt="Chamber122" />
      </div>
      <div class="footer-section">
        <h3>Chamber122</h3>
        <p>Connecting Kuwait's MSMEs with opportunities for growth and success. Join our community today.</p>
      </div>
      
      <div class="footer-section">
        <h3>Quick Links</h3>
        <div class="quick-links">
          <ul class="quick-links-list">
            <li><a href="index.html">Home</a></li>
            <li><a href="directory.html">Directory</a></li>
            <li><a href="events.html">Events</a></li>
            <li><a href="bulletin.html">Bulletin</a></li>
            <li><a href="get-listed.html">Get Listed</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-section">
        <h3>Connect</h3>
        <p><a href="https://instagram.com/chamber_122_kw"><i class="fab fa-instagram"></i> Instagram</a></p>
        <p><a href="https://www.tiktok.com/@chamber122"><i class="fab fa-tiktok"></i> TikTok</a></p>
        <p><a href="https://wa.me/96522396999"><i class="fab fa-whatsapp"></i> Phone</a></p>
        <p><a href="mailto:info@chamber122.com"><i class="fas fa-envelope"></i> info@chamber122.com</a></p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 Chamber122. All Rights Reserved. | Empowering Kuwait's MSMEs</p>
    </div>
  </footer>

  <!-- Load Supabase client FIRST -->
  <!-- Supabase Bootstrap Loader with multiple fallbacks -->
  <script type="module" id="supabase-loader">
    (async () => {
      const sources = [
        'https://esm.sh/@supabase/supabase-js@2',
        'https://unpkg.com/@supabase/supabase-js@2.45.3/dist/module/index.js',
        'https://cdn.skypack.dev/@supabase/supabase-js@2'
      ];
      
      for (const src of sources) {
        try {
          console.log('[bootstrap] Trying to load Supabase from:', src);
          window.__supabaseMod = await import(src);
          console.log('[bootstrap] Successfully loaded from:', src);
          window.__supabaseReady = true;
          return;
        } catch (e) {
          console.warn('[bootstrap] Failed to load from', src, e);
        }
      }
      
      console.error('[bootstrap] All Supabase sources failed. Network may be down.');
      window.__supabaseReady = true; // Set ready anyway to prevent infinite wait
    })();
  </script>
  
  <!-- Supabase client initialization -->
  <script type="module" src="/js/supabase-client.global.js"></script>
  
  <!-- Classic scripts for owner page -->
  <script src="/js/i18n.js?v=1"></script>
  <script src="/js/language-switcher.js?v=1"></script>
  <script type="module" src="/js/businesses.api.js"></script>
  <script type="module" src="/js/business-form.js?v=3"></script>
  <script type="module" src="/public/js/header-auth-slot.js"></script>
  
  <!-- Load and display business data -->
  <script type="module" src="/js/owner.js"></script>
  
  <!-- Initialize page -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.initActivitiesPage) {
        window.initActivitiesPage();
      }
    });
  </script>

</body>
</html>


          // Show registration buttons for non-owners viewing the profile
          const showReg = !isOwner;
          
          // Combine all events for "All" tab
          const allEvents = [...data.events.ongoing, ...data.events.upcoming, ...data.events.previous];
          renderList(document.getElementById('ev-all'), allEvents, (e) => eventCard(e, showReg), 'No events.');
          
          renderList(document.getElementById('ev-ongoing'),  data.events.ongoing,  (e) => eventCard(e, showReg), 'No ongoing events.');
          renderList(document.getElementById('ev-upcoming'), data.events.upcoming, (e) => eventCard(e, showReg), 'No upcoming events.');
          renderList(document.getElementById('ev-previous'), data.events.previous, (e) => eventCard(e, false), 'No previous events.');

          // Combine all bulletins for "All" tab
          const allBulletins = [...data.bulletins.ongoing, ...data.bulletins.upcoming, ...data.bulletins.previous];
          renderList(document.getElementById('bl-all'), allBulletins, (b) => bulletinCard(b, showReg), 'No bulletins.');
          
          renderList(document.getElementById('bl-ongoing'), data.bulletins.ongoing, (b) => bulletinCard(b, showReg), 'No ongoing bulletins.');
          renderList(document.getElementById('bl-upcoming'), data.bulletins.upcoming, (b) => bulletinCard(b, showReg), 'No upcoming bulletins.');
          renderList(document.getElementById('bl-previous'), data.bulletins.previous, (b) => bulletinCard(b, false), 'No previous bulletins.');
        } catch (error) {
          console.error('[owner] Error loading events/bulletins:', error);
        }
      } else {
        console.log('[owner] No ownerId found, cannot load events/bulletins');
        // Show message to user
        const evContainer = document.getElementById('ev-ongoing');
        const blContainer = document.getElementById('bl-ongoing');
        if (evContainer) {
          evContainer.innerHTML = '<p style="text-align: center; color: #AFAFAF; padding: 20px;">Please create a business profile first.</p>';
        }
        if (blContainer) {
          blContainer.innerHTML = '<p style="text-align: center; color: #AFAFAF; padding: 20px;">Please create a business profile first.</p>';
        }
      }

      // Load registrations if owner is viewing own profile
      if (isOwner && ownerId) {
        try {
          const { loadRegistrations, renderRegistrations } = await import('/assets/js/registrations.js');
          
          // Wire up registration tabs
          function wireRegistrationTabs() {
            const regSection = document.getElementById('registrations-section');
            if (!regSection) return;
            
            regSection.querySelectorAll('.tabs .tab').forEach(btn => {
              btn.addEventListener('click', () => {
                const group = regSection;
                group.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const target = btn.dataset.tab;
                group.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
                group.querySelector(`#${target}`)?.classList.remove('hidden');
              });
            });
          }

          wireRegistrationTabs();

          // Load and display registrations
          const regData = await loadRegistrations();
          
          // Update count
          const countEl = document.getElementById('registrations-count');
          if (countEl) {
            const totalCount = regData.all.length;
            countEl.textContent = totalCount;
            countEl.style.display = totalCount > 0 ? 'inline-block' : 'none';
          }

          // Render all registrations
          renderRegistrations(document.getElementById('registrations-all'), regData.all);
          renderRegistrations(document.getElementById('registrations-events'), regData.events);
          renderRegistrations(document.getElementById('registrations-bulletins'), regData.bulletins);
          
          // Render pending
          const pending = regData.all.filter(r => r.status === 'pending');
          renderRegistrations(document.getElementById('registrations-pending'), pending);

          // Make reload function available globally
          window.reloadRegistrations = async () => {
            const regData = await loadRegistrations();
            const countEl = document.getElementById('registrations-count');
            if (countEl) {
              const totalCount = regData.all.length;
              countEl.textContent = totalCount;
              countEl.style.display = totalCount > 0 ? 'inline-block' : 'none';
            }
            renderRegistrations(document.getElementById('registrations-all'), regData.all);
            renderRegistrations(document.getElementById('registrations-events'), regData.events);
            renderRegistrations(document.getElementById('registrations-bulletins'), regData.bulletins);
            const pending = regData.all.filter(r => r.status === 'pending');
            renderRegistrations(document.getElementById('registrations-pending'), pending);
          };
        } catch (error) {
          console.error('[owner] Error loading registrations:', error);
        }
      }
      
      // Setup real-time updates for profile, events, bulletins, and registrations
      if (ownerId) {
        setupRealtimeProfileUpdates(ownerId);
      }
    }

    // Setup real-time updates for profile viewing
    function setupRealtimeProfileUpdates(businessId) {
      // Subscribe to business updates
      const businessChannel = supabase
        .channel(`business-profile:${businessId}`)
        .on(
          'postgres_changes',
          {
            event: 'UPDATE',
            schema: 'public',
            table: 'businesses',
            filter: `id=eq.${businessId}`
          },
          (payload) => {
            console.log('[owner] Business updated via real-time:', payload);
            // Reload the page to show updated data
            window.location.reload();
          }
        )
        .subscribe();
      
      // Subscribe to events
      const eventsChannel = supabase
        .channel(`profile-events:${businessId}`)
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'events',
            filter: `business_id=eq.${businessId}`
          },
          async (payload) => {
            console.log('[owner] Event changed:', payload);
            // Reload events
            const data = await loadOwnerEventsAndBulletins(businessId, isOwnerViewing);
            const showReg = !isOwnerViewing;
            
            // Combine all events for "All" tab
            const allEvents = [...data.events.ongoing, ...data.events.upcoming, ...data.events.previous];
            renderList(document.getElementById('ev-all'), allEvents, (e) => eventCard(e, showReg), 'No events.');
            
            renderList(document.getElementById('ev-ongoing'),  data.events.ongoing,  (e) => eventCard(e, showReg), 'No ongoing events.');
            renderList(document.getElementById('ev-upcoming'), data.events.upcoming, (e) => eventCard(e, showReg), 'No upcoming events.');
            renderList(document.getElementById('ev-previous'), data.events.previous, (e) => eventCard(e, false), 'No previous events.');
          }
        )
        .subscribe();
      
      // Subscribe to bulletins
      const bulletinsChannel = supabase
        .channel(`profile-bulletins:${businessId}`)
        .on(
          'postgres_changes',
          {
            event: '*',
            schema: 'public',
            table: 'bulletins',
            filter: `business_id=eq.${businessId}`
          },
          async (payload) => {
            console.log('[owner] Bulletin changed:', payload);
            // Reload bulletins
            const data = await loadOwnerEventsAndBulletins(businessId, isOwnerViewing);
            const showReg = !isOwnerViewing;
            
            // Combine all bulletins for "All" tab
            const allBulletins = [...data.bulletins.ongoing, ...data.bulletins.upcoming, ...data.bulletins.previous];
            renderList(document.getElementById('bl-all'), allBulletins, (b) => bulletinCard(b, showReg), 'No bulletins.');
            
            renderList(document.getElementById('bl-ongoing'), data.bulletins.ongoing, (b) => bulletinCard(b, showReg), 'No ongoing bulletins.');
            renderList(document.getElementById('bl-upcoming'), data.bulletins.upcoming, (b) => bulletinCard(b, showReg), 'No upcoming bulletins.');
            renderList(document.getElementById('bl-previous'), data.bulletins.previous, (b) => bulletinCard(b, false), 'No previous bulletins.');
          }
        )
        .subscribe();
      
      // Subscribe to registrations - reload when new registrations are added
      // Note: We can't filter by business_id in the subscription, so we'll reload all and filter client-side
      const registrationsChannel = supabase
        .channel(`profile-registrations:${businessId}`)
        .on(
          'postgres_changes',
          {
            event: '*', // Listen to INSERT, UPDATE, DELETE
            schema: 'public',
            table: 'registrations'
          },
          async (payload) => {
            console.log('[owner] Registration change detected:', payload);
            // Reload registrations if owner is viewing their own profile
            if (isOwnerViewing && window.reloadRegistrations) {
              console.log('[owner] Reloading registrations after change...');
              setTimeout(() => window.reloadRegistrations(), 500); // Small delay to ensure DB is updated
            }
          }
        )
        .subscribe();
    }

    // Registration functions for events and bulletins
    window.registerForEvent = async function(eventId) {
      try {
        const name = prompt('Enter your name:');
        if (!name) return;
        
        const email = prompt('Enter your email:');
        if (!email) return;
        
        const phone = prompt('Enter your phone (optional):') || null;
        
        const { data, error } = await supabase
          .from('registrations')
          .insert({
            type: 'event',
            item_id: eventId,
            name: name,
            email: email,
            phone: phone,
            status: 'pending'
          })
          .select()
          .single();
        
        if (error) {
          // Handle case where registrations table might not exist
          if (error.code === '42P01' || error.message?.includes('does not exist')) {
            console.error('Registrations table does not exist:', error);
            alert('Registration feature is not available yet. Please contact the organizer directly.');
            return;
          }
          throw error;
        }
        
        console.log('[registration] Event registration created:', data);
        alert('Registration submitted successfully! The organizer will contact you soon.');
        
        // If owner is viewing their own profile, reload registrations
        if (isOwnerViewing && window.reloadRegistrations) {
          setTimeout(() => window.reloadRegistrations(), 1000);
        }
      } catch (error) {
        console.error('Registration error:', error);
        alert('Failed to register: ' + (error.message || 'Unknown error'));
      }
    };
    
    window.registerForBulletin = async function(bulletinId) {
      try {
        const name = prompt('Enter your name:');
        if (!name) return;
        
        const email = prompt('Enter your email:');
        if (!email) return;
        
        const phone = prompt('Enter your phone (optional):') || null;
        
        const { data, error } = await supabase
          .from('registrations')
          .insert({
            type: 'bulletin',
            item_id: bulletinId,
            name: name,
            email: email,
            phone: phone,
            status: 'pending'
          })
          .select()
          .single();
        
        if (error) {
          // Handle case where registrations table might not exist
          if (error.code === '42P01' || error.message?.includes('does not exist')) {
            console.error('Registrations table does not exist:', error);
            alert('Registration feature is not available yet. Please contact the organizer directly.');
            return;
          }
          throw error;
        }
        
        console.log('[registration] Bulletin registration created:', data);
        alert('Response submitted successfully! The organizer will contact you soon.');
        
        // If owner is viewing their own profile, reload registrations
        if (isOwnerViewing && window.reloadRegistrations) {
          setTimeout(() => window.reloadRegistrations(), 1000);
        }
      } catch (error) {
        console.error('Registration error:', error);
        alert('Failed to respond: ' + (error.message || 'Unknown error'));
      }
    };

    init();
  </script>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-brand">
        <img src="images/logo.png" alt="Chamber122" />
      </div>
      <div class="footer-section">
        <h3>Chamber122</h3>
        <p>Connecting Kuwait's MSMEs with opportunities for growth and success. Join our community today.</p>
      </div>
      
      <div class="footer-section">
        <h3>Quick Links</h3>
        <div class="quick-links">
          <ul class="quick-links-list">
            <li><a href="index.html">Home</a></li>
            <li><a href="directory.html">Directory</a></li>
            <li><a href="events.html">Events</a></li>
            <li><a href="bulletin.html">Bulletin</a></li>
            <li><a href="get-listed.html">Get Listed</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-section">
        <h3>Connect</h3>
        <p><a href="https://instagram.com/chamber_122_kw"><i class="fab fa-instagram"></i> Instagram</a></p>
        <p><a href="https://www.tiktok.com/@chamber122"><i class="fab fa-tiktok"></i> TikTok</a></p>
        <p><a href="https://wa.me/96522396999"><i class="fab fa-whatsapp"></i> Phone</a></p>
        <p><a href="mailto:info@chamber122.com"><i class="fas fa-envelope"></i> info@chamber122.com</a></p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 Chamber122. All Rights Reserved. | Empowering Kuwait's MSMEs</p>
    </div>
  </footer>

  <!-- Load Supabase client FIRST -->
  <!-- Supabase Bootstrap Loader with multiple fallbacks -->
  <script type="module" id="supabase-loader">
    (async () => {
      const sources = [
        'https://esm.sh/@supabase/supabase-js@2',
        'https://unpkg.com/@supabase/supabase-js@2.45.3/dist/module/index.js',
        'https://cdn.skypack.dev/@supabase/supabase-js@2'
      ];
      
      for (const src of sources) {
        try {
          console.log('[bootstrap] Trying to load Supabase from:', src);
          window.__supabaseMod = await import(src);
          console.log('[bootstrap] Successfully loaded from:', src);
          window.__supabaseReady = true;
          return;
        } catch (e) {
          console.warn('[bootstrap] Failed to load from', src, e);
        }
      }
      
      console.error('[bootstrap] All Supabase sources failed. Network may be down.');
      window.__supabaseReady = true; // Set ready anyway to prevent infinite wait
    })();
  </script>
  
  <!-- Supabase client initialization -->
  <script type="module" src="/js/supabase-client.global.js"></script>
  
  <!-- Classic scripts for owner page -->
  <script src="/js/i18n.js?v=1"></script>
  <script src="/js/language-switcher.js?v=1"></script>
  <script type="module" src="/js/businesses.api.js"></script>
  <script type="module" src="/js/business-form.js?v=3"></script>
  <script type="module" src="/public/js/header-auth-slot.js"></script>
  
  <!-- Load and display business data -->
  <script type="module" src="/js/owner.js"></script>
  
  <!-- Initialize page -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.initActivitiesPage) {
        window.initActivitiesPage();
      }
    });
  </script>

</body>
</html>
